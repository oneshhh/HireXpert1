<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>HireXpert - My Interviews</title>
<link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
      :root {
        --primary-50: #eff6ff;
        --primary-600: #2563eb; /* Tailwind blue-600 */
        --primary-color: #2563eb; /* Added for consistency */
        --gray-500: #6b7280;
        --info-50: #ecfeff;
        --info-500: #06b6d4;
      }
      .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      }
      #create-interview-btn {
        background-color: var(--primary-600) !important;
        color: white !important;
      }
      .tab-active {
        border-bottom-color: var(--primary-600);
        color: var(--primary-600);
        font-weight: 600;
      }
      .modal-hidden { display: none; }
      /* Notification Modal Styles */
      #notification-modal { transition: opacity 0.3s ease-out; }
      #notification-modal > div { transition: all 0.3s ease-out; }
</style>
</head>
<body class="bg-gray-50" style='font-family: "Inter", "Noto Sans", sans-serif;'>

<!-- [NEW] This page now has two main sections: login and dashboard -->

<!-- == SECTION 1: LOGIN FORM (Hidden by default) == -->
<!-- == SECTION 1: REVIEWER LOGIN (NEW GREEN DESIGN) == -->
<div id="login-section" class="min-h-screen w-full grid grid-cols-1 md:grid-cols-2 overflow-hidden">

  <!-- LEFT PANEL: Green curved background + login form -->
  <div class="relative flex items-center justify-center px-10 py-12 curve-bg-green text-white">

    <!-- Floating shapes -->
    <div class="absolute -top-6 right-10 w-14 h-14 rounded-3xl border border-white/40 float-slow opacity-60"></div>
    <div class="absolute bottom-10 -left-4 w-10 h-10 rounded-full bg-white/10 float-slow-delay"></div>
    <div class="absolute top-24 left-10 w-3 h-3 rounded-full bg-lime-300 float-slow-delay"></div>

    <div class="relative z-10 w-full max-w-md">
      <!-- Title -->
      <h1 class="text-4xl font-extrabold mb-2">Reviewer Login</h1>
      <p class="text-lime-100 text-sm mb-8">
        Sign in to review candidate interviews assigned to you.
      </p>

      <!-- LOGIN CARD -->
      <div class="bg-white text-gray-900 rounded-xl shadow-xl p-7">
        <h2 class="text-xl font-semibold mb-5 text-gray-800">Welcome Back</h2>

        <form id="login-form" class="space-y-4">
          <div>
            <label class="block text-xs text-gray-600 mb-1">Email Address</label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <div>
            <label class="block text-xs text-gray-600 mb-1">Password</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500"
            />
          </div>

          <div id="login-error" class="text-sm text-red-600 text-center"></div>

          <button
            type="submit"
            id="login-btn"
            class="w-full py-2.5 rounded-lg bg-green-600 text-white font-medium shadow hover:bg-green-700 transition"
          >
            Login
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- RIGHT PANEL — placeholder for reviewer illustration -->
  <div class="relative hidden md:flex items-center justify-center bg-white">
    <div
      class="absolute -top-10 -right-10 w-40 h-40 rounded-full bg-green-100 opacity-40">
    </div>

    <div
      class="absolute bottom-0 left-6 w-32 h-32 rounded-3xl bg-emerald-100 opacity-50">
    </div>

    <!-- Image placeholder container -->
    <div class="w-full h-full flex items-center justify-center p-10">
      <!-- Replace src below with your reviewer illustration -->
      <img
        src="views-assets/image2.png"
        alt="Reviewer Illustration"
        class="w-full h-auto max-w-xl object-contain opacity-90"
      />
    </div>
  </div>
</div>

<!-- GREEN CURVE BG STYLE -->
<style>
  .curve-bg-green {
    background: linear-gradient(135deg, #0f9b4f 0%, #10b981 50%, #34d399 100%);
    clip-path: ellipse(100% 100% at 0% 50%);
  }
  @keyframes float-slow {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-12px); }
    100% { transform: translateY(0px); }
  }
  .float-slow {
    animation: float-slow 8s ease-in-out infinite;
  }
  .float-slow-delay {
    animation: float-slow 10s ease-in-out infinite;
    animation-delay: 1.5s;
  }
</style>


<!-- == SECTION 2: DASHBOARD (Hidden by default) == -->
<div id="dashboard-section" class="hidden flex min-h-screen w-full flex-col">
  <header class="flex shrink-0 items-center justify-between border-b border-gray-200 bg-white px-6 py-3">
    <div class="flex items-center gap-6">
      <div class="flex items-center gap-3 text-gray-800">
        <svg class="h-8 w-8 text-primary-600" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_6_319)"><path d="M8.57829 8.57829C5.52816 11.6284 3.451 15.5145 2.60947 19.7452C1.76794 23.9758 2.19984 28.361 3.85056 32.3462C5.50128 36.3314 8.29667 39.7376 11.8832 42.134C15.4698 44.5305 19.6865 45.8096 24 45.8096C28.3135 45.8096 32.5302 44.5305 36.1168 42.134C39.7033 39.7375 42.4987 36.3314 44.1494 32.3462C45.8002 28.361 46.2321 23.9758 45.3905 19.7452C44.549 15.5145 42.4718 11.6284 39.4217 8.57829L24 24L8.57829 8.57829Z" fill="currentColor"></path></g><defs><clipPath id="clip0_6_319"><rect fill="white" height="48" width="48"></rect></clipPath></defs></svg>
        <h1 class="text-xl font-bold text-gray-900">HireXpert</h1>
      </div>
    </div>
    <div class="flex items-center gap-4">
      <div class="relative w-full max-w-xs">
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
        <input id="search-bar" class="form-input w-full rounded-md border-gray-300 bg-white pl-10 text-sm focus:border-primary-500 focus:ring-primary-500" placeholder="Search by title or ID..."/>
      </div>
      <div class="relative">
          <button id="profile-menu-button" type="button" class="flex rounded-full bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
              <span class="sr-only">Open user menu</span>
              <div class="h-9 w-9 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden">
                  <span id="profile-initials" class="text-sm font-medium text-gray-600"></span>
              </div>
          </button>
          <div id="profile-menu-dropdown"
                class="hidden absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none"
                role="menu" aria-orientation="vertical" aria-labelledby="profile-menu-button" tabindex="-1">
                <div class="border-b border-gray-200 px-4 py-3 text-sm">
                    <p class="font-medium text-gray-900">Signed in as</p>
                    <p id="user-email-display" class="truncate text-gray-500">Loading...</p>
                </div>
                <div class="py-1" role="none">
                    <!-- [FIXED] This link's href will be set dynamically by JavaScript -->
                    <a href="/logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" tabindex="-1" id="user-menu-item-logout">Sign out</a>
                </div>
          </div>
      </div>
      </div>
  </header>

  <main class="flex-1 px-8 py-8 md:px-12 lg:px-16">
    <div class="mx-auto max-w-7xl">
      <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
        <h2 class="text-3xl font-bold text-gray-900">My Assigned Interviews</h2>
      </div>

      <div id="bulk-actions-bar" class="hidden mb-4 rounded-md bg-primary-50 p-3 flex items-center justify-between">
        <p class="text-sm font-medium text-primary-700"><span id="selected-count">0</span> interviews selected</p>
        <div>
          <button id="delete-selected-btn" class="rounded-md bg-red-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Delete</button>
        </div>
      </div>

      <div class="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="relative px-6 py-3"><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"></th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">S.No.</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Title</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Status</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Invited</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">To Evaluate</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Evaluated</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Discarded</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="interviews-table-body" class="divide-y divide-gray-200 bg-white"></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<!-- Modals (No changes) -->
<div id="confirm-modal" class="modal-hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50">
    <div class="w-full max-w-sm transform rounded-lg bg-white p-6 shadow-xl">
        <h3 id="confirm-modal-title" class="text-lg font-medium text-gray-900">Are you sure?</h3>
        <div class="mt-2">
            <p id="confirm-modal-text" class="text-sm text-gray-500">This action cannot be undone.</p>
        </div>
        <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
            <button id="confirm-modal-confirm-btn" type="button" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2">Confirm</button>
            <button id="confirm-modal-cancel-btn" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">Cancel</button>
        </div>
    </div>
</div>

<div id="notification-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 transition-opacity duration-300 ease-out opacity-0">
    <div class="w-full max-w-sm transform rounded-lg bg-white p-6 shadow-xl text-center transition-all duration-300 ease-out scale-95 opacity-0"
         role="alertdialog" aria-modal="true" aria-labelledby="notification-modal-title">
        <div id="notification-modal-icon" class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100">
             <span class="material-symbols-outlined text-3xl text-green-600">check_circle</span>
        </div>
        <h3 id="notification-modal-title" class="mt-4 text-lg font-medium text-gray-900">Success!</h3>
        <div class="mt-2">
            <p id="notification-modal-text" class="text-sm text-gray-500">Your action was completed successfully.</p>
        </div>
        <div id="notification-modal-buttons" class="mt-5 sm:mt-6">
            </div>
    </div>
</div>

<script>
  let selectedInterviewIds = new Set();
  let allInterviews = [];
  let currentUserType = 'none'; // 'user' or 'visitor'

  // --- Notification Modal Helpers (No changes) ---
  const notificationModal = document.getElementById('notification-modal');
  const notificationDialog = notificationModal ? notificationModal.querySelector('[role="alertdialog"]') : null;
  const showModal = () => {
    if (!notificationModal || !notificationDialog) return;
    notificationModal.classList.remove('hidden');
    setTimeout(() => {
      notificationModal.classList.add('opacity-100');
      notificationDialog.classList.remove('scale-95', 'opacity-0');
      notificationDialog.classList.add('scale-100', 'opacity-100');
    }, 10);
  };
  const hideModal = () => {
    if (!notificationModal || !notificationDialog) return;
    notificationModal.classList.remove('opacity-100');
    notificationDialog.classList.remove('scale-100', 'opacity-100');
    notificationDialog.classList.add('scale-95', 'opacity-0');
    setTimeout(() => {
      notificationModal.classList.add('hidden');
    }, 300);
  };
  function showNotification(title, text, options = {}) {
      const { isError = false, onConfirm = null, confirmText = 'Confirm', cancelText = 'Cancel', duration = null } = options;
      const modalTitle = document.getElementById('notification-modal-title');
      const modalText = document.getElementById('notification-modal-text');
      const modalIcon = document.getElementById('notification-modal-icon');
      const btnContainer = document.getElementById('notification-modal-buttons');
      if (!notificationModal || !modalTitle || !modalText || !modalIcon || !btnContainer) {
          alert(`${title}: ${text}`); return;
      }
      modalTitle.textContent = title;
      modalText.textContent = text;
      if (isError) { modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-red-600">error</span>`; modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100"; }
      else { modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-green-600">check_circle</span>`; modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100"; }
      btnContainer.innerHTML = '';
      if (onConfirm) {
          btnContainer.className = 'mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3';
          const confirmBtn = document.createElement('button');
          confirmBtn.type = 'button';
          confirmBtn.className = isError ? 'inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2' : 'inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:col-start-2';
          confirmBtn.textContent = confirmText;
          confirmBtn.onclick = () => { hideModal(); onConfirm(); };
          const cancelBtn = document.createElement('button');
          cancelBtn.type = 'button';
          cancelBtn.className = 'mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0';
          cancelBtn.textContent = cancelText;
          cancelBtn.onclick = () => { hideModal(); };
          btnContainer.appendChild(cancelBtn);
          btnContainer.appendChild(confirmBtn);
      } else {
           btnContainer.className = 'mt-5 sm:mt-6';
           if (duration === null || duration <= 0) {
              const okBtn = document.createElement('button');
              okBtn.type = 'button';
              okBtn.className = 'inline-flex w-full justify-center rounded-md bg-[var(--primary-color)] px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-opacity-90';
              okBtn.textContent = 'Got it';
              okBtn.onclick = () => { hideModal(); };
              btnContainer.appendChild(okBtn);
           }
      }
      showModal();
      if (duration > 0 && !onConfirm) { setTimeout(() => { hideModal(); }, duration); }
  }

  // --- Confirmation Modal Logic (No changes) ---
  const confirmModal = document.getElementById('confirm-modal');
  let confirmCallback = null;
  function showConfirmModal(title, text, onConfirm) {
      document.getElementById('confirm-modal-title').textContent = title;
      document.getElementById('confirm-modal-text').textContent = text;
      confirmCallback = onConfirm;
      confirmModal.classList.remove('modal-hidden');
  }
  function hideConfirmModal() {
      confirmModal.classList.add('modal-hidden');
      confirmCallback = null;
  }

  (async function initViewerSession() {
  const params = new URLSearchParams(window.location.search);
  window.currentCandidateToken = params.get("token");
  window.currentInterviewId = params.get("interview_id");
  currentToken = window.currentCandidateToken;
  currentInterviewId = window.currentInterviewId;

  const token = params.get("token");
  if (!token) return;

  try {
    const res = await fetch(`/api/viewer/init?token=${token}`, {
      credentials: "include"
    });
    if (res.ok) {
      console.log("✅ Viewer session initialized");
    } else {
      console.warn("⚠️ Viewer init failed:", await res.text());
    }
  } catch (err) {
    console.error("Error initializing viewer session:", err);
  }
})();


  // --- [NEW] Dashboard Functions ---
  async function showDashboard(user, userType = 'user') {
      // 1. Populate user info in header
      if (user) {
          document.getElementById('user-email-display').textContent = user.email;
          document.getElementById('profile-initials').textContent = user.email.substring(0, 1).toUpperCase();
      }
      
      // 2. [FIXED] Set the correct logout link
      const logoutLink = document.getElementById('user-menu-item-logout');
      if (userType === 'visitor') {
          logoutLink.href = '/viewer/logout';
          // Make logout a client-side action for visitors
          logoutLink.onclick = async (e) => {
              e.preventDefault();
              await fetch('/viewer/logout', { credentials: 'include' });
              showLogin();
          };
      } else {
          // Internal users use the standard /logout redirect
          logoutLink.href = '/logout';
          logoutLink.onclick = null; // Remove any client-side click handler
      }
      
      // 3. Show dashboard, hide login
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('dashboard-section').classList.remove('hidden');
      
      // 4. Fetch interviews
      await fetchAndRenderInterviews(userType);
  }

  function showLogin() {
      document.getElementById('login-section').classList.remove('hidden');
      document.getElementById('dashboard-section').classList.add('hidden');
  }

  // [UPDATED] Fetches assigned interviews based on user type
  async function fetchAndRenderInterviews(userType) {
    try {
        // [FIXED] Call the correct API based on who is logged in
        const apiUrl = userType === 'visitor' 
            ? '/api/viewer/assigned-interviews' // API for visitors
            : '/api/me/assigned-interviews';    // API for internal users (from review.routes.js)

        const res = await fetch(apiUrl);
        if (!res.ok) {
            if (res.status === 401) {
                // This can happen if a session expires
                console.warn(`Session expired for ${userType}. Showing login.`);
                showLogin();
            } else {
                throw new Error(`Failed to fetch interviews: ${res.statusText}`);
            }
            return;
        }
        allInterviews = await res.json(); // Data now includes stats
        
        const searchBar = document.getElementById('search-bar');
        renderTable(searchBar.value);

} catch (err) { 
        console.error(`Error loading assigned interviews for ${userType}:`, err); 
        // This is a server or network error. Show a message, don't log out.
        showNotification(
            'Error Loading Interviews', 
            'Could not load interview data. Please check your connection and try again.', 
            { isError: true }
        );
    }
}
  // [UPDATED] Renders table with new stats structure (No changes to this function)
  function renderTable(searchTerm = '') {
    const tbody = document.querySelector("#interviews-table-body");
    tbody.innerHTML = "";
    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    const filteredInterviews = allInterviews.filter(interview => {
        const titleMatch = interview.title.toLowerCase().includes(lowerCaseSearchTerm);
        const idMatch = interview.custom_interview_id ? interview.custom_interview_id.toLowerCase().includes(lowerCaseSearchTerm) : false;
        return titleMatch || idMatch;
    });

    if (filteredInterviews.length === 0) {
        tbody.innerHTML = `<tr><td colspan="10" class="text-center py-10 text-gray-500">No ${searchTerm ? 'matching' : ''} interviews are assigned to you.</td></tr>`;
        return;
    }

    filteredInterviews.forEach((interview, index) => {
        const tr = document.createElement("tr");
        const isSelected = selectedInterviewIds.has(interview.id);
        const viewLink = `/interview-view.html?id=${interview.id}&from=interview-viewer.html`;


        const stats = interview.stats || {};
        const invitedCount = stats.invited || 0;
        const toEvaluateCount = stats.toEvaluate || 0;
        const evaluatedCount = stats.evaluated || 0;
        const discardedCount = stats.discarded || 0;
        
        const statusClass = interview.position_status === 'open' ? 'text-green-600' : 'text-gray-500';
        const statusText = interview.position_status === 'open' ? 'Open' : 'Closed';

        tr.innerHTML = `
            <td class="relative px-6 py-4"><input type="checkbox" data-id="${interview.id}" class="row-checkbox h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500" ${isSelected ? 'checked' : ''}></td>
            <td class="px-4 py-4 text-sm text-gray-500">${index + 1}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${interview.custom_interview_id || 'N/A'}</td>
            <td class="px-6 py-4"><a href="${viewLink}" class="font-medium text-gray-900 hover:text-primary-600">${interview.title}</a></td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${statusClass}">${statusText}</td>
            <td class="px-6 py-4"><span class="inline-flex items-center rounded-md bg-yellow-100 px-2.5 py-1 text-sm font-semibold text-yellow-800">${invitedCount}</span></td>
            <td class="px-6 py-4"><span class="inline-flex items-center rounded-md bg-amber-100 px-2.5 py-1 text-sm font-semibold text-amber-800">${toEvaluateCount}</span></td>
            <td class="px-6 py-4"><span class="inline-flex items-center rounded-md bg-green-100 px-2.5 py-1 text-sm font-semibold text-green-800">${evaluatedCount}</span></td>
            <td class="px-6 py-4"><span class="inline-flex items-center rounded-md bg-red-100 px-2.5 py-1 text-sm font-semibold text-red-800">${discardedCount}</span></td>
            <td class="whitespace-nowrap px-6 py-4 text-sm font-medium">
                <a href="${viewLink}" class="text-primary-600 hover:text-primary-900">View</a>
            </td>
        `;
        tbody.appendChild(tr);
    });
  }

  // --- Bulk Action Bar Logic (No changes) ---
  function updateBulkActionBar() {
    const bar = document.getElementById('bulk-actions-bar');
    const countSpan = document.getElementById('selected-count');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    
    if (selectedInterviewIds.size > 0) {
        bar.classList.remove('hidden');
        countSpan.textContent = selectedInterviewIds.size;
        const visibleRowCount = document.querySelectorAll('#interviews-table-body tr:not([style*="display: none"]) .row-checkbox').length;
        selectAllCheckbox.checked = selectedInterviewIds.size === visibleRowCount && visibleRowCount > 0;
    } else {
        bar.classList.add('hidden');
        selectAllCheckbox.checked = false;
    }
  }


  // --- Event Listeners ---
  document.addEventListener('DOMContentLoaded', () => {
    // --- Auth Elements ---
    const loginForm = document.getElementById('login-form');
    const loginBtn = document.getElementById('login-btn');
    const loginError = document.getElementById('login-error');

    // --- Dashboard Elements ---
    const searchBar = document.getElementById('search-bar');
    const tableBody = document.getElementById('interviews-table-body');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
    const cancelBtn = document.getElementById('confirm-modal-cancel-btn');

    // --- Profile Dropdown Elements ---
    const profileButton = document.getElementById('profile-menu-button');
    const profileDropdown = document.getElementById('profile-menu-dropdown');

    // --- [FIXED] Login Form Handler ---
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        loginBtn.disabled = true;
        loginBtn.textContent = 'Logging in...';
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        try {
            // [FIXED] Call the correct API for VISITORS
            const response = await fetch('/viewer/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password }),
                credentials: 'include' // ✅ required for cookie-session to persist login
            });
            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.message || 'Login failed');
            }
            // On success, show the dashboard for a 'visitor'
            showDashboard(data, 'visitor');
        } catch (error) {
            loginError.textContent = error.message;
        } finally {
            loginBtn.disabled = false;
            loginBtn.textContent = 'Login';
        }
    });

    // Confirmation Modal Buttons (No changes)
    confirmBtn.addEventListener('click', () => {
        if (typeof confirmCallback === 'function') confirmCallback();
        hideConfirmModal();
    });
    cancelBtn.addEventListener('click', hideConfirmModal);
    
    // Row Checkbox Handling (No changes)
    tableBody.addEventListener('change', (e) => {
        if (e.target.classList.contains('row-checkbox')) {
            const id = e.target.dataset.id;
            if (e.target.checked) selectedInterviewIds.add(id);
            else selectedInterviewIds.delete(id);
            updateBulkActionBar();
        }
    });

    // Select All Checkbox Handling (No changes)
    selectAllCheckbox.addEventListener('change', (e) => {
        const checkboxes = tableBody.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => {
            if (cb.closest('tr') && !cb.closest('tr').style.display?.includes('none')) {
                cb.checked = e.target.checked;
                const id = cb.dataset.id;
                if (e.target.checked) selectedInterviewIds.add(id);
                else selectedInterviewIds.delete(id);
            }
        });
        updateBulkActionBar();
    });

    // Bulk Action Buttons (No changes)
    deleteSelectedBtn.addEventListener('click', () => {
        showConfirmModal(
            `Delete ${selectedInterviewIds.size} interviews?`,
            "This action is permanent. All associated candidate data will also be deleted.",
            async () => {
                await fetch('/api/interviews/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interviewIds: Array.from(selectedInterviewIds) })
                });
                selectedInterviewIds.clear();
                updateBulkActionBar();
                // [FIXED] Pass the current user type to the fetch function
                await fetchAndRenderInterviews(currentUserType);
            }
        );
    });

    // Search Bar (No changes)
    searchBar.addEventListener('input', (e) => {
      renderTable(e.target.value);
      updateBulkActionBar();
    });

    // Profile Dropdown (No changes)
    if (profileButton && profileDropdown) {
        profileButton.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('hidden');
        });
        document.addEventListener('click', (event) => {
            if (!profileButton.contains(event.target) && !profileDropdown.contains(event.target)) {
                profileDropdown.classList.add('hidden');
            }
        });
    }
    
    // --- [FIXED] Initial Load Logic ---// 
(async function checkSession() {
  try {
    // 1) Try the main /api/me first
    const userResponse = await fetch('/api/me');
    if (userResponse.ok) {
      const payload = await userResponse.json();

      // Normalize shapes:
      // - payload might be { email, id, ... }
      // - or { type: 'user', id, email, ... }
      // - or { type: 'viewer', viewer: { id, email, name } } (unlikely here, but be safe)
      let normalizedUser = null;
      if (payload && typeof payload === 'object') {
        if (payload.email) {
          normalizedUser = payload; // already has email
        } else if (payload.type === 'user' && payload.email) {
          normalizedUser = { id: payload.id, email: payload.email, ...payload };
        } else if (payload.type === 'viewer' && payload.viewer && payload.viewer.email) {
          // if server returned viewer inside /api/me for some reason
          normalizedUser = { id: payload.viewer.id, email: payload.viewer.email, name: payload.viewer.name };
        }
      }

      if (normalizedUser) {
        currentUserType = (payload.type === 'viewer') ? 'visitor' : 'user';
        showDashboard(normalizedUser, currentUserType === 'visitor' ? 'visitor' : 'user');
        return;
      } else {
        // If /api/me returned something unexpected but ok, fall through and check /viewer/me
        console.warn('/api/me returned an unexpected shape:', payload);
      }
    }

    // 2) Check visitor session explicitly
    const visitorResponse = await fetch('/viewer/me', { credentials: 'include' });
    if (visitorResponse.ok) {
      const visitorPayload = await visitorResponse.json();
      // visitorPayload is expected to be { id, email, ... }
      if (visitorPayload && visitorPayload.email) {
        currentUserType = 'visitor';
        // normalize into expected shape for showDashboard
        const normalizedVisitor = { id: visitorPayload.id, email: visitorPayload.email, name: visitorPayload.name || null };
        showDashboard(normalizedVisitor, 'visitor');
        return;
      } else {
        console.warn('/viewer/me returned but missing email:', visitorPayload);
      }
    }

    // 3) No active session found
    throw new Error('No active session');

  } catch (err) {
    console.log('No active session or session shape mismatch — showing login.', err);
    currentUserType = 'none';
    showLogin();
  }
})();
    });
</script>

</body>
</html>