<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Interview Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
      :root {
        --primary-color: #2563eb; /* Tailwind blue-600 */
        --secondary-color: #f0f2f4;
        --text-primary: #111418;
        --text-secondary: #617589;
      }
      body { font-family: 'Inter', sans-serif; }
      /* Style for the resend button */
      .resend-btn {
        @apply ml-4 px-2 py-1 text-xs font-medium text-blue-600 bg-blue-100 rounded hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1;
      }
      .resend-btn:disabled {
        @apply opacity-50 cursor-not-allowed bg-gray-100 text-gray-400;
      }
      /* Notification Modal Styles */
      #notification-modal { transition: opacity 0.3s ease-out; }
      #notification-modal > div { transition: all 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold text-[var(--text-primary)]">HireXpert</h1>
        <a id="back-link" href="/admin_Dashboard.html" class="text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--primary-color)]">&larr; Back to Dashboard</a>
    </div>
  </header>

  <main class="container mx-auto mt-8 px-6 pb-12">
    <div id="loading-state" class="text-center p-10">
        <p class="text-gray-500">Loading interview details...</p>
    </div>
    <div id="error-state" class="hidden text-center p-10 bg-red-50 rounded-lg">
        <p class="text-red-600 font-medium">Could not load interview details.</p>
        <p id="error-message" class="text-red-500 text-sm mt-2"></p>
    </div>

    <div id="interview-content" class="hidden space-y-8">
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="flex flex-col md:flex-row justify-between md:items-center">
                <div>
                    <h2 id="title" class="text-3xl font-bold text-gray-800"></h2>
                    <p id="custom-id" class="text-sm text-gray-500 mt-1"></p>
                </div>
                <div id="status-badge" class="mt-4 md:mt-0 text-sm font-semibold px-4 py-2 rounded-full"></div>
            </div>
            <div class="mt-6 border-t border-gray-200 pt-6 grid grid-cols-2 md:grid-cols-3 gap-6 text-sm">
                <div>
                    <p class="text-gray-500 font-medium">Scheduled On</p>
                    <p id="date" class="text-gray-900 font-semibold"></p>
                </div>
                <div>
                    <p class="text-gray-500 font-medium">Time</p>
                    <p id="time" class="text-gray-900 font-semibold"></p>
                </div>
                <div>
                    <p class="text-gray-500 font-medium">Created By</p>
                    <p id="scheduler-name" class="text-gray-900 font-semibold"></p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 bg-white shadow-lg rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Job Description</h3>
                <pre id="job-description" class="text-sm text-gray-700 whitespace-pre-wrap font-sans bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto"></pre>
            </div>
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Invited Candidates</h3>
                <ul id="candidate-list" class="space-y-3 max-h-96 overflow-y-auto">
                    </ul>
            </div>
        </div>

        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Interview Questions</h3>
                <button id="toggle-questions-btn" class="text-sm font-semibold text-blue-600 hover:underline focus:outline-none">Show All</button>
            </div>
            <ul id="questions-list" class="space-y-4 hidden">
                </ul>
        </div>
    </div>
  </main>

  <div id="notification-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 transition-opacity duration-300 ease-out opacity-0">
    <div class="w-full max-w-sm transform rounded-lg bg-white p-6 shadow-xl text-center transition-all duration-300 ease-out scale-95 opacity-0"
         role="alertdialog" aria-modal="true" aria-labelledby="notification-modal-title">
        <div id="notification-modal-icon" class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100">
             <span class="material-symbols-outlined text-3xl text-green-600">check_circle</span>
        </div>
        <h3 id="notification-modal-title" class="mt-4 text-lg font-medium text-gray-900">Success!</h3>
        <div class="mt-2">
            <p id="notification-modal-text" class="text-sm text-gray-500">Your action was completed successfully.</p>
        </div>
        <div id="notification-modal-buttons" class="mt-5 sm:mt-6">
            </div>
    </div>
  </div>

  <script>
    // --- Global variable to store interview ID ---
    let currentInterviewId = null;

    // --- Notification Modal Helpers ---
    const notificationModal = document.getElementById('notification-modal');
    const notificationDialog = notificationModal ? notificationModal.querySelector('[role="alertdialog"]') : null;

    const showModal = () => {
      if (!notificationModal || !notificationDialog) return;
      notificationModal.classList.remove('hidden');
      setTimeout(() => { // Allow display change before starting transition
        notificationModal.classList.add('opacity-100');
        notificationDialog.classList.remove('scale-95', 'opacity-0');
        notificationDialog.classList.add('scale-100', 'opacity-100');
      }, 10);
    };
    const hideModal = () => {
      if (!notificationModal || !notificationDialog) return;
      notificationModal.classList.remove('opacity-100');
      notificationDialog.classList.remove('scale-100', 'opacity-100');
      notificationDialog.classList.add('scale-95', 'opacity-0');
      setTimeout(() => { // Wait for transition before hiding
        notificationModal.classList.add('hidden');
      }, 300); // Match transition duration
    };

    // --- Utility and Notification Function (with auto-hide) ---
    function showNotification(title, text, options = {}) {
        const { isError = false, onConfirm = null, confirmText = 'Confirm', cancelText = 'Cancel', duration = null } = options;

        const modalTitle = document.getElementById('notification-modal-title');
        const modalText = document.getElementById('notification-modal-text');
        const modalIcon = document.getElementById('notification-modal-icon');
        const btnContainer = document.getElementById('notification-modal-buttons');

        if (!notificationModal || !modalTitle || !modalText || !modalIcon || !btnContainer) {
            alert(`${title}: ${text}`); // Fallback
            return;
        }

        modalTitle.textContent = title;
        modalText.textContent = text;

        if (isError) {
            modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-red-600">error</span>`;
            modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100";
        } else {
            modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-green-600">check_circle</span>`;
            modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100";
        }

        btnContainer.innerHTML = ''; // Clear previous buttons

        if (onConfirm) { // Show Confirm/Cancel buttons
            btnContainer.className = 'mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3';
            const confirmBtn = document.createElement('button');
            confirmBtn.type = 'button';
            confirmBtn.className = isError ? 'inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2' : 'inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:col-start-2';
            confirmBtn.textContent = confirmText;
            confirmBtn.onclick = () => { hideModal(); onConfirm(); };

            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.className = 'mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0';
            cancelBtn.textContent = cancelText;
            cancelBtn.onclick = () => { hideModal(); };

            btnContainer.appendChild(cancelBtn);
            btnContainer.appendChild(confirmBtn);
        } else { // Show only an "OK" or auto-hide
             btnContainer.className = 'mt-5 sm:mt-6';
             if (duration === null || duration <= 0) { // Only show button if NOT auto-hiding
                const okBtn = document.createElement('button');
                okBtn.type = 'button';
                okBtn.className = 'inline-flex w-full justify-center rounded-md bg-[var(--primary-color)] px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-opacity-90';
                okBtn.textContent = 'Got it';
                okBtn.onclick = () => { hideModal(); };
                btnContainer.appendChild(okBtn);
             }
        }

        showModal(); // Use helper to show with transition

        // Auto-hide logic
        if (duration > 0 && !onConfirm) {
            setTimeout(() => {
                hideModal(); // Use helper to hide with transition
            }, duration);
        }
    }


    // --- Resend Invite Function ---
    async function resendInvite(button, candidateEmail) {
        if (!currentInterviewId) {
            showNotification('Error', 'Interview ID not found.', { isError: true });
            return;
        }

        button.disabled = true;
        button.textContent = 'Sending...';

        try {
            const response = await fetch('/api/resend-invite', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    interviewId: currentInterviewId,
                    candidateEmail: candidateEmail
                })
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || 'Failed to resend invite.');
            }

            // Use showNotification for success with 3-second auto-hide
            showNotification('Success!', `Invite resent to ${candidateEmail}`, { duration: 3000 });

            button.textContent = 'Sent!'; // Keep visual feedback
            // Reset button after notification disappears + buffer
            setTimeout(() => {
                 button.textContent = 'Resend';
                 button.disabled = false;
            }, 3500); // duration + 500ms

        } catch (error) {
            console.error('Error resending invite:', error);
            showNotification('Error', error.message, { isError: true });
            button.textContent = 'Resend'; // Reset button on error
            button.disabled = false;
        }
    }


    // --- Fetch Interview Details Function ---
    async function fetchInterview() {
      const content = document.getElementById('interview-content');
      const loading = document.getElementById('loading-state');
      const errorDiv = document.getElementById('error-state');
      const errorMessage = document.getElementById('error-message');
      const backLink = document.getElementById('back-link');

      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      const from = params.get("from"); // Get 'from' for back link

      currentInterviewId = id; // Store ID globally

      if (!id) {
        loading.style.display = 'none';
        errorDiv.classList.remove('hidden');
        errorMessage.textContent = "No interview ID provided in the URL.";
        return;
      }
      
      // Set back link dynamically
      if (from && from !== 'null' && from !== 'undefined') { // Check if 'from' is valid
          backLink.href = `/${from}`;
      } else {
          backLink.href = '/admin_Dashboard.html'; // Sensible default
      }


      try {
        const res = await fetch(`/api/interview/${id}`);
        if (!res.ok) {
            const errData = await res.json();
            throw new Error(errData.message || "Interview not found");
        }
        const data = await res.json();

        // Populate Header Card
        document.getElementById("title").textContent = data.title;
        document.getElementById("custom-id").textContent = `ID: ${data.custom_interview_id || 'N/A'}`;
        document.getElementById("date").textContent = data.date ? new Date(data.date).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' }) : 'N/A';
        document.getElementById("time").textContent = data.time || 'N/A';
        document.getElementById("scheduler-name").textContent = `${data.first_name || 'N/A'} ${data.last_name || ''}`;
        
        const statusBadge = document.getElementById("status-badge");
        statusBadge.className = 'mt-4 md:mt-0 text-sm font-semibold px-4 py-2 rounded-full'; // Reset
        if (data.position_status === 'open') {
            statusBadge.textContent = 'Open';
            statusBadge.classList.add('bg-green-100', 'text-green-800');
        } else {
            statusBadge.textContent = 'Closed';
            statusBadge.classList.add('bg-red-100', 'text-red-800');
        }

        // Populate Job Description
        const jdElement = document.getElementById("job-description");
        if (data.job_description) {
            jdElement.textContent = data.job_description;
        } else {
            jdElement.textContent = "No job description was provided for this interview.";
            jdElement.classList.add('italic', 'text-gray-500');
        }
        
        // Populate Candidates with Resend Button
        const candidateList = document.getElementById("candidate-list");
        candidateList.innerHTML = "";
        if (data.candidates && data.candidates.length > 0) {
            data.candidates.forEach(candidate => {
                const li = document.createElement("li");
                li.className = 'flex items-center justify-between text-sm pr-2 py-1';
                
                const emailSpan = document.createElement('span');
                emailSpan.className = 'text-gray-800 truncate mr-2';
                emailSpan.textContent = candidate.candidate_email;

                const statusSpan = document.createElement('span');
                statusSpan.className = `px-2 py-1 rounded-full text-xs whitespace-nowrap ${candidate.status === 'Completed' ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'}`;
                statusSpan.textContent = candidate.status;
                
                const resendButton = document.createElement('button');
                resendButton.className = 'resend-btn flex-shrink-0';
                resendButton.textContent = 'Resend';
                resendButton.onclick = () => resendInvite(resendButton, candidate.candidate_email);

                const infoDiv = document.createElement('div');
                infoDiv.className = 'flex items-center flex-grow min-w-0';
                infoDiv.appendChild(emailSpan);
                infoDiv.appendChild(statusSpan);

                li.appendChild(infoDiv);
                li.appendChild(resendButton);

                candidateList.appendChild(li);
            });
        } else {
            candidateList.innerHTML = '<li class="text-sm text-gray-500 italic">No candidates are associated with this interview.</li>';
        }

        // Populate Questions
        const qList = document.getElementById("questions-list");
        qList.innerHTML = "";
        const questions = data.questions || [];
        const timeLimits = data.time_limits || [];
        if (questions.length > 0) {
            questions.forEach((q, index) => {
                const li = document.createElement("li");
                li.className = "p-3 bg-gray-50 rounded-md flex items-start justify-between";
                const time = timeLimits[index] || 0;
                li.innerHTML = `
                    <span class="text-gray-800">${q}</span>
                    <span class="text-xs text-gray-500 whitespace-nowrap ml-4 pt-1">${time > 0 ? time + ' sec' : 'Untimed'}</span>
                `;
                qList.appendChild(li);
            });
        } else {
            qList.innerHTML = '<li class="text-sm text-gray-500 italic">No questions were added to this interview.</li>';
        }

        // Show content
        loading.style.display = 'none';
        content.classList.remove('hidden');

      } catch (err) {
        loading.style.display = 'none';
        errorDiv.classList.remove('hidden');
        errorMessage.textContent = err.message;
      }
    }

    fetchInterview();
    
    // Add event listener for the toggle questions button
    const toggleBtn = document.getElementById('toggle-questions-btn');
    const questionsList = document.getElementById('questions-list');
    
    if (toggleBtn && questionsList) { // Check if elements exist
        toggleBtn.addEventListener('click', () => {
            questionsList.classList.toggle('hidden');
            const isHidden = questionsList.classList.contains('hidden');
            toggleBtn.textContent = isHidden ? 'Show All' : 'Hide All';
        });
    }
  </script>
</body>
</html>