<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Interview Details</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>

    <style>
      :root {
        --primary-color: #2563eb; /* Tailwind blue-600 */
        --secondary-color: #f0f2f4;
        --text-primary: #111418;
        --text-secondary: #617589;
      }
      body { font-family: 'Inter', sans-serif; }

      /* Resend button */
      .resend-btn {
        padding: 0.25rem 0.6rem;
        font-size: 0.78rem;
        font-weight: 500;
        color: #2563eb;
        background-color: #dbeafe;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: background-color 0.15s ease, box-shadow 0.15s ease;
        white-space: nowrap;
        min-width: 60px;
        text-align: center;
      }
      .resend-btn:hover { background-color: #bfdbfe; }
      .resend-btn:focus { outline: none; box-shadow: 0 0 0 3px rgba(59,130,246,0.15); }
      .resend-btn:disabled { opacity: 0.6; cursor: not-allowed; background-color: #f3f4f6; color: #9ca3af; }

      /* Notification Modal */
      #notification-modal { transition: opacity 0.3s ease-out; }
      #notification-modal > div { transition: all 0.3s ease-out; }

      .candidate-line {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 140px 110px; /* email | status | actions (resend) */
        gap: 12px;
        align-items: center;
      }
      .candidate-line .candidate-info {
        min-width: 0; /* allow proper truncation/wrapping inside grid */
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      /* Emails: allow wrapping (so full email visible across lines), but avoid single-letter vertical stacking */
      .candidate-email {
        white-space: normal;
        overflow-wrap: anywhere;
        word-break: break-word;
        font-size: 0. ninerem; /* fallback removed, will set below */
        font-size: 0. ninerem;
      }
      /* small text variant used in submissions */
      .candidate-email.small {
        font-size: 0.85rem;
        color: #6b7280;
      }

      /* Ensure reasonable font sizes (fixing earlier accidental decimals) */
      .candidate-email { font-size: 0.92rem; color: #111827; line-height: 1.25; }

      /* Status tag - fixed width column, center align inside */
      .candidate-status {
        display: inline-block;
        padding: 6px 10px;
        border-radius: 999px;
        text-align: center;
        font-size: 0.78rem;
        font-weight: 600;
        min-width: 110px;
        white-space: nowrap;
      }

      /* Submission items (review submissions) - layout with status visible */
      .submission-item {
        display: grid;
        grid-template-columns: minmax(0, 1fr) 140px; /* info | controls (status/select) */
        gap: 12px;
        align-items: center;
      }

      /* Remove underline on hover for links inside submission-item */
      .submission-item a { text-decoration: none; color: #1e3a8a; }
      .submission-item a:hover { text-decoration: none; color: #1e40af; }

      @media (max-width: 640px) {
        /* Stack columns on very small screens */
        .candidate-line, .submission-item {
          grid-template-columns: 1fr;
          gap: 8px;
        }
        .candidate-status { min-width: unset; text-align: left; }
        .candidate-email { white-space: normal; } /* allow wrapping on tiny screens */
      }

      /* Header stats: center on desktop, stacked on mobile */
      .header-stats { gap: 16px; }
      @media (min-width: 768px) {
        .header-stats { display: grid; grid-template-columns: repeat(3, 1fr); text-align: center; align-items: center; }
      }

      /* Small visual helpers */
      .question-item { display:flex; justify-content:space-between; gap:12px; align-items:center; }
      .bg-blue-100 { background-color: #DBEAFE; color: #1E3A8A; }
      .bg-yellow-100 { background-color: #FEF3C7; color: #92400E; }
      .bg-green-100 { background-color: #DCFCE7; color: #065F46; }
      .bg-red-100 { background-color: #FEE2E2; color: #7F1D1D; }
    </style>
</head>
<body class="bg-gray-100">
  <header class="bg-white shadow-sm">
    <div class="container mx-auto px-6 py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold text-[var(--text-primary)]">HireXpert</h1>
        <a id="back-link" href="/admin_Dashboard.html" class="text-sm font-medium text-[var(--text-secondary)] hover:text-[var(--primary-color)]">&larr; Back to Dashboard</a>
    </div>
  </header>

  <main class="container mx-auto mt-8 px-6 pb-12">
    <div id="loading-state" class="text-center p-10">
        <p class="text-gray-500">Loading interview details...</p>
    </div>
    <div id="error-state" class="hidden text-center p-10 bg-red-50 rounded-lg">
        <p class="text-red-600 font-medium">Could not load interview details.</p>
        <p id="error-message" class="text-red-500 text-sm mt-2"></p>
    </div>

    <div id="interview-content" class="hidden space-y-8">
        <!-- Interview Header Card -->
        <div class="bg-white shadow-lg rounded-lg p-6">
          <div class="flex flex-col md:flex-row justify-between md:items-center">
              <div>
                  <h2 id="title" class="text-3xl font-bold text-gray-800"></h2>
                  <p id="custom-id" class="text-sm text-gray-500 mt-1"></p>
              </div>

              <div class="flex items-center gap-3 mt-4 md:mt-0">
                  <div id="status-badge" class="text-sm font-semibold px-4 py-2 rounded-full"></div>

                  <!-- DOWNLOAD BUTTON -->
                  <button id="download-report-btn"
                      class="px-4 py-2 text-sm font-semibold bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
                      Download Report
                  </button>
              </div>
          </div>
            <!-- CENTERED STATS ROW -->
            <div class="mt-6 border-t border-gray-200 pt-6 text-sm header-stats">
                <div>
                    <p class="text-gray-500 font-medium">Scheduled On</p>
                    <p id="date" class="text-gray-900 font-semibold"></p>
                </div>
                <div>
                    <p class="text-gray-500 font-medium">Time</p>
                    <p id="time" class="text-gray-900 font-semibold"></p>
                </div>
                <div>
                    <p class="text-gray-500 font-medium">Created By</p>
                    <p id="scheduler-name" class="text-gray-900 font-semibold"></p>
                </div>
            </div>
        </div>

        <!-- Job Description & Candidate Grid
             NOTE: make candidates card wider: job description col-span = 1, candidates col-span = 2
        -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 bg-white shadow-lg rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Job Description</h3>
                <pre id="job-description" class="text-sm text-gray-700 whitespace-pre-wrap font-sans bg-gray-50 p-4 rounded-md max-h-96 overflow-y-auto"></pre>
            </div>

            <!-- Candidates Card with Tabs (wider now) -->
            <div class="lg:col-span-2 bg-white shadow-lg rounded-lg">
                <div class="border-b border-gray-200">
                    <nav class="-mb-px flex" aria-label="Tabs">
                        <button id="tab-submissions"
                                onclick="switchTab('submissions')"
                                class="w-1/2 border-b-2 border-blue-600 py-4 px-1 text-center text-sm font-medium text-blue-600"
                                aria-current="page">
                            Review Submissions
                        </button>
                        <button id="tab-invites"
                                onclick="switchTab('invites')"
                                class="w-1/2 border-b-2 border-transparent py-4 px-1 text-center text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">
                            Pending Submissions
                        </button>
                    </nav>
                </div>

                <div class="p-6">
                    <!-- Panel 1: Review Submissions -->
                    <div id="panel-submissions">
                        <ul id="submission-list" class="space-y-4 max-h-96 overflow-y-auto">
                            <li class="text-sm text-gray-500 italic">Loading submissions...</li>
                        </ul>
                    </div>

                    <!-- Panel 2: Pending Invites -->
                    <div id="panel-invites" class="hidden">
                        <ul id="candidate-list" class="space-y-3 max-h-96 overflow-y-auto"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Interview Questions Card -->
        <div class="bg-white shadow-lg rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Interview Questions</h3>
                <div>
                    <button id="show-more-questions-btn" class="hidden text-sm font-semibold text-blue-600 hover:underline focus:outline-none">Show More</button>
                    <button id="show-less-questions-btn" class="hidden text-sm font-semibold text-blue-600 hover:underline focus:outline-none">Show Less</button>
                </div>
            </div>
            <ul id="questions-list" class="space-y-4"></ul>
        </div>
    </div>
  </main>

  <!-- Notification Modal -->
  <div id="notification-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 transition-opacity duration-300 ease-out opacity-0">
    <div class="w-full max-w-sm transform rounded-lg bg-white p-6 shadow-xl text-center transition-all duration-300 ease-out scale-95 opacity-0"
         role="alertdialog" aria-modal="true" aria-labelledby="notification-modal-title">
        <div id="notification-modal-icon" class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100">
             <span class="material-symbols-outlined text-3xl text-green-600">check_circle</span>
        </div>
        <h3 id="notification-modal-title" class="mt-4 text-lg font-medium text-gray-900">Success!</h3>
        <div class="mt-2">
            <p id="notification-modal-text" class="text-sm text-gray-500">Your action was completed successfully.</p>
        </div>
        <div id="notification-modal-buttons" class="mt-5 sm:mt-6"></div>
    </div>
  </div>

  <script>
    // --- Global variable (Unchanged) ---
    let currentInterviewId = null;
    // --- Detect if current user is a viewer ---
let isViewer = false;

async function checkUserType() {
  try {
    const resp = await fetch('/api/me', { credentials: 'include' });
    if (!resp.ok) { isViewer = true; return; } // fallback if no login session
    const data = await resp.json();
    // assume API returns { type: 'user' | 'viewer' }
    if (data.type && data.type !== 'user') isViewer = true;
  } catch {
    isViewer = true;
  }
}


    // --- Notification Modal Helpers (Unchanged) ---
    const notificationModal = document.getElementById('notification-modal');
    const notificationDialog = notificationModal ? notificationModal.querySelector('[role="alertdialog"]') : null;
    const showModal = () => { if (!notificationModal || !notificationDialog) return; notificationModal.classList.remove('hidden'); setTimeout(() => { notificationModal.classList.add('opacity-100'); notificationDialog.classList.remove('scale-95', 'opacity-0'); notificationDialog.classList.add('scale-100', 'opacity-100'); }, 10); };
    const hideModal = () => { if (!notificationModal || !notificationDialog) return; notificationModal.classList.remove('opacity-100'); notificationDialog.classList.remove('scale-100', 'opacity-100'); notificationDialog.classList.add('scale-95', 'opacity-0'); setTimeout(() => { notificationModal.classList.add('hidden'); }, 300); };
    function showNotification(title, text, options = {}) { const { isError = false, onConfirm = null, confirmText = 'Confirm', cancelText = 'Cancel', duration = null } = options; const modalTitle = document.getElementById('notification-modal-title'); const modalText = document.getElementById('notification-modal-text'); const modalIcon = document.getElementById('notification-modal-icon'); const btnContainer = document.getElementById('notification-modal-buttons'); if (!notificationModal || !modalTitle || !modalText || !modalIcon || !btnContainer) { alert(`${title}: ${text}`); return; } modalTitle.textContent = title; modalText.textContent = text; if (isError) { modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-red-600">error</span>`; modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100"; } else { modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-green-600">check_circle</span>`; modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100"; } btnContainer.innerHTML = ''; if (onConfirm) { btnContainer.className = 'mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3'; const confirmBtn = document.createElement('button'); confirmBtn.type = 'button'; confirmBtn.className = isError ? 'inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2' : 'inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:col-start-2'; confirmBtn.textContent = confirmText; confirmBtn.onclick = () => { hideModal(); onConfirm(); }; const cancelBtn = document.createElement('button'); cancelBtn.type = 'button'; cancelBtn.className = 'mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0'; cancelBtn.textContent = cancelText; cancelBtn.onclick = () => { hideModal(); }; btnContainer.appendChild(cancelBtn); btnContainer.appendChild(confirmBtn); } else { btnContainer.className = 'mt-5 sm:mt-6'; if (duration === null || duration <= 0) { const okBtn = document.createElement('button'); okBtn.type = 'button'; okBtn.className = 'inline-flex w-full justify-center rounded-md bg-[var(--primary-color)] px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-opacity-90'; okBtn.textContent = 'Got it'; okBtn.onclick = () => { hideModal(); }; btnContainer.appendChild(okBtn); } } showModal(); if (duration > 0 && !onConfirm) { setTimeout(() => { hideModal(); }, duration); } }

    // --- Resend Invite Function (Unchanged logic) ---
    async function resendInvite(button, candidateEmail) {
        if (!currentInterviewId) { showNotification('Error', 'Interview ID not found.', { isError: true }); return; }
        button.disabled = true; const originalText = button.textContent; button.textContent = 'Sending...';
        try {
            const response = await fetch('/api/resend-invite', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ interviewId: currentInterviewId, candidateEmail: candidateEmail }) });
            const result = await response.json(); if (!response.ok) { throw new Error(result.message || 'Failed to resend invite.'); }
            showNotification('Success!', `Invite resent to ${candidateEmail}`, { duration: 2000 }); button.textContent = 'Sent!'; setTimeout(() => { button.textContent = originalText; button.disabled = false; }, 3500);
        } catch (error) { console.error('Error resending invite:', error); showNotification('Error', error.message, { isError: true }); button.textContent = originalText; button.disabled = false; }
    }

    // --- Tab Switching Function (Unchanged) ---
    function switchTab(activeTab) {
        const subTab = document.getElementById('tab-submissions');
        const subPanel = document.getElementById('panel-submissions');
        const invTab = document.getElementById('tab-invites');
        const invPanel = document.getElementById('panel-invites');
        if (activeTab === 'submissions') {
            subTab.classList.add('border-blue-600', 'text-blue-600');
            subTab.classList.remove('border-transparent', 'text-gray-500');
            subPanel.classList.remove('hidden');
            invTab.classList.add('border-transparent', 'text-gray-500');
            invTab.classList.remove('border-blue-600', 'text-blue-600');
            invPanel.classList.add('hidden');
        } else {
            invTab.classList.add('border-blue-600', 'text-blue-600');
            invTab.classList.remove('border-transparent', 'text-gray-500');
            invPanel.classList.remove('hidden');
            subTab.classList.add('border-transparent', 'text-gray-500');
            subTab.classList.remove('border-blue-600', 'text-blue-600');
            subPanel.classList.add('hidden');
        }
    }

    // --- Function to Update Reviewer Status (Fixed) ---
    async function updateReviewerStatus(selectElement, email, interviewId) {
        const newStatus = selectElement.value;
        selectElement.disabled = true;

        try {
            const response = await fetch('/api/candidate/status', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include', // âœ… ensures session cookie is sent
                body: JSON.stringify({
                    candidate_email: email,
                    status: newStatus,
                    interview_id: interviewId
                })
            });

            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.message || 'Failed to update status');
            }

            showNotification('Status Saved', `Set to ${newStatus}.`, { duration: 1500 });
        } catch (error) {
            console.error('Error updating status:', error);
            showNotification('Error', error.message, { isError: true });
        } finally {
            selectElement.disabled = false;
        }
    }


    // --- Function to Fetch Submissions (Restored name link + status tag) ---
    async function fetchSubmissions() {
      if (!currentInterviewId) return;
      const list = document.getElementById('submission-list');

      try {
        const res = await fetch(`/api/interview/${currentInterviewId}/submissions`);
        if (!res.ok) {
          const err = await res.json().catch(()=>({message:'Failed to load'}));
          throw new Error(err.message || 'Could not load submissions');
        }

        const submissions = await res.json();
        list.innerHTML = '';

        if (!Array.isArray(submissions) || submissions.length === 0) {
          list.innerHTML = '<li class="text-sm text-gray-500 italic">No candidate submissions found for this interview.</li>';
          return;
        }

        // status color mapping for submission status badges
        const statusClassMap = {
          'completed': 'bg-green-100',
          'started': 'bg-blue-100',
          'opened': 'bg-yellow-100',
          'error': 'bg-red-100'
        };

    submissions.forEach(candidate => {
        // Determine submission status FIRST
        const submissionStatus = (candidate.submission_status || 'Invited').toString();

        // Skip candidates who have not submitted anything
        if (submissionStatus === "Invited") return;

        const li = document.createElement('li');
        li.className = 'submission-item p-2 rounded-md hover:bg-gray-50';

        // Candidate info container
        const left = document.createElement('div');
        left.style.minWidth = '0';

        // token fallback
        const token = candidate.candidate_token || candidate.token || candidate.token_id || '';

        // Use name AFTER submission, otherwise fallback to email
        const displayName = candidate.name ? candidate.name : candidate.email;

        // Correct clickable name link
        const nameLink = token
            ? `<a href="/candidate-review.html?token=${encodeURIComponent(token)}&interview_id=${encodeURIComponent(currentInterviewId)}" class="font-medium">${displayName}</a>`
            : `<span style="font-weight:600;color:#1f2937">${displayName}</span>`;

        // Status badge
        const stKey = submissionStatus.toLowerCase();
        let statusBadgeHtml = '';
        if (submissionStatus) {
            const cls = statusClassMap[stKey] || 'bg-gray-100';
            statusBadgeHtml = `<span class="candidate-status ${cls}" style="margin-left:8px">${submissionStatus}</span>`;
        }

        // email below name
        const emailHtml = `<div class="candidate-email small" title="${candidate.email || ''}">${candidate.email || ''}</div>`;

        left.innerHTML = `${nameLink} ${statusBadgeHtml} ${emailHtml}`;

        // Right side (reviewer dropdown)
        const right = document.createElement('div');
        right.style.display = 'flex';
        right.style.gap = '8px';
        right.style.alignItems = 'center';

        const select = document.createElement('select');
        select.className = 'text-xs rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500';
        select.innerHTML = `
            <option value="To Evaluate">To Evaluate</option>
            <option value="Evaluated">Evaluated</option>
            <option value="Discarded">Discarded</option>
        `;

        if (candidate.reviewer_status) select.value = candidate.reviewer_status;

        if (isViewer) {
            const tag = document.createElement('span');
            tag.className = 'candidate-status bg-gray-100 text-gray-800';
            tag.textContent = candidate.reviewer_status || 'To Evaluate';
            right.appendChild(tag);
        } else {
            select.onchange = function () {
                updateReviewerStatus(this, candidate.email, currentInterviewId);
            };
            right.appendChild(select);
        }

        li.appendChild(left);
        li.appendChild(right);
        list.appendChild(li);
    });
          } catch (error) {
            console.error('Error fetching submissions:', error);
            list.innerHTML = `<li class="text-sm text-red-500">Error loading submissions: ${error.message}</li>`;
          }
        }


    // --- Fetch Interview Details Function (UI data + pending invites rendering) ---
    async function fetchInterview() {
      await checkUserType(); // detect if viewer before building UI
      const content = document.getElementById('interview-content');
      const loading = document.getElementById('loading-state');
      const errorDiv = document.getElementById('error-state');
      const errorMessage = document.getElementById('error-message');
      const backLink = document.getElementById('back-link');

      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      const from = params.get("from");
      currentInterviewId = id;

      if (!id) {
        loading.style.display = 'none';
        errorDiv.classList.remove('hidden');
        errorMessage.textContent = "No interview ID provided in the URL.";
        return;
      }
      if (from && from !== 'null' && from !== 'undefined') { backLink.href = `/${from}`; } else { backLink.href = '/admin_Dashboard.html'; }

      try {
        const res = await fetch(`/api/interview/${id}`);
        if (!res.ok) { const errData = await res.json(); throw new Error(errData.message || "Interview not found"); }
        const data = await res.json();

        // Populate Header Card (UI only)
        document.getElementById("title").textContent = data.title;
        document.getElementById("custom-id").textContent = `ID: ${data.custom_interview_id || 'N/A'}`;
        document.getElementById("date").textContent = data.date ? new Date(data.date).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric', timeZone: 'UTC' }) : 'N/A';
        document.getElementById("time").textContent = data.time || 'N/A';
        document.getElementById("scheduler-name").textContent = `${data.first_name || 'N/A'} ${data.last_name || ''}`;

        const statusBadge = document.getElementById("status-badge");
        statusBadge.className = 'mt-4 md:mt-0 text-sm font-semibold px-4 py-2 rounded-full';
        if (data.position_status === 'open') { statusBadge.textContent = 'Open'; statusBadge.classList.add('bg-green-100', 'text-green-800'); }
        else { statusBadge.textContent = 'Closed'; statusBadge.classList.add('bg-red-100', 'text-red-800'); }

        // Populate Job Description
        const jdElement = document.getElementById("job-description");
        if (data.job_description) { jdElement.textContent = data.job_description; }
        else { jdElement.textContent = "No job description was provided for this interview."; jdElement.classList.add('italic', 'text-gray-500'); }

        // --- Populate Candidates (Pending Invites Tab) ---
        const candidateList = document.getElementById("candidate-list");
        candidateList.innerHTML = "";
        if (data.candidates && data.candidates.length > 0) {
          data.candidates.forEach(candidate => {
            const li = document.createElement("li");
            li.className = 'candidate-line text-sm pr-2 py-2 items-center';

            // Column 1: email/info (wrap-capable)
            const infoDiv = document.createElement('div');
            infoDiv.className = 'candidate-info';
            const nameDiv = document.createElement('div');
            const emailDiv = document.createElement('div');
            emailDiv.className = 'candidate-email';
            emailDiv.textContent = candidate.candidate_email || '';
            emailDiv.title = candidate.candidate_email || '';
            infoDiv.appendChild(nameDiv);
            infoDiv.appendChild(emailDiv);

            // Column 2: status tag
            const statusDiv = document.createElement('div');
            statusDiv.style.display = 'flex';
            statusDiv.style.justifyContent = 'center';
            statusDiv.style.alignItems = 'center';
            const statusSpan = document.createElement('span');
            statusSpan.className = 'candidate-status';
            const st = (candidate.status || 'Invited').toLowerCase();

            if (st === 'opened') {
                statusSpan.classList.add('bg-yellow-100');
                statusSpan.style.color = '#92400E';
                statusSpan.textContent = 'Opened';
            }
            else if (st === 'started') {
                statusSpan.classList.add('bg-blue-100');
                statusSpan.style.color = '#1E3A8A';
                statusSpan.textContent = 'Started';
            }
            else { 
                // Default (Invited)
                statusSpan.classList.add('bg-yellow-100');
                statusSpan.style.color = '#92400E';
                statusSpan.textContent = 'Invited';
            }

            statusDiv.appendChild(statusSpan);

            const btnDiv = document.createElement('div');
            btnDiv.style.display = 'flex';
            btnDiv.style.justifyContent = 'flex-end';
            btnDiv.style.alignItems = 'center';
            btnDiv.style.gap = '8px';

            // SHOW RESEND ONLY FOR USERS (not viewers)
            if (!isViewer) {
                const resendButton = document.createElement('button');
                resendButton.className = 'resend-btn';
                resendButton.textContent = 'Resend';
                resendButton.onclick = () =>
                    resendInvite(resendButton, candidate.candidate_email);
                btnDiv.appendChild(resendButton);
            } else {
                // VIEWERS get nothing (empty right column)
                btnDiv.textContent = ''; 
            }

            li.appendChild(infoDiv);
            li.appendChild(statusDiv);
            li.appendChild(btnDiv);
            candidateList.appendChild(li);
          });
        } else {
          candidateList.innerHTML = '<li class="text-sm text-gray-500 italic">No candidates are associated with this interview.</li>';
        }

        // Populate Questions (unchanged logic)
        const qList = document.getElementById("questions-list");
        qList.innerHTML = "";
        const questions = data.questions || [];
        const timeLimits = data.time_limits || [];
        if (questions.length > 0) {
            questions.forEach((q, index) => {
                const li = document.createElement("li");
                li.className = "p-3 bg-gray-50 rounded-md flex items-start justify-between question-item";
                if (index >= 5) li.classList.add('extra-question');
                const time = timeLimits[index] || 0;
                li.innerHTML = `<span class="text-gray-800">${q}</span><span class="text-xs text-gray-500 whitespace-nowrap ml-4 pt-1">${time > 0 ? time + ' sec' : 'Untimed'}</span>`;
                qList.appendChild(li);
            });
            if (questions.length > 5) { document.getElementById('show-more-questions-btn').classList.remove('hidden'); }
        } else {
            qList.innerHTML = '<li class="text-sm text-gray-500 italic">No questions were added to this interview.</li>';
        }

        // Show content
        loading.style.display = 'none';
        content.classList.remove('hidden');

        // Fetch submissions for the other tab
        fetchSubmissions();

      } catch (err) {
        loading.style.display = 'none';
        errorDiv.classList.remove('hidden');
        errorMessage.textContent = err.message;
      }
    }

    // --- Run Fetch Function ---
    fetchInterview();

document.getElementById("download-report-btn").addEventListener("click", () => {
    if (!currentInterviewId) {
        showNotification("Error", "Interview ID not available.", { isError: true });
        return;
    }

    const url = `/api/interview/${currentInterviewId}/download`;

    // Force browser download
    const a = document.createElement("a");
    a.href = url;
    a.download = "";
    document.body.appendChild(a);
    a.click();
    a.remove();
});


    // --- Show More / Less buttons (unchanged) ---
    const showMoreBtn = document.getElementById('show-more-questions-btn');
    const showLessBtn = document.getElementById('show-less-questions-btn');
    showMoreBtn.addEventListener('click', () => { document.querySelectorAll('.extra-question').forEach(q => { q.style.display = 'flex'; }); showMoreBtn.classList.add('hidden'); showLessBtn.classList.remove('hidden'); });
    showLessBtn.addEventListener('click', () => { document.querySelectorAll('.extra-question').forEach(q => { q.style.display = 'none'; }); showLessBtn.classList.add('hidden'); showMoreBtn.classList.remove('hidden'); });
  </script>
</body>
</html>