<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Edit Interview</title>
<link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700;900&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style>
  :root { --primary-color: #1173d4; }
  body { font-family: 'Inter', sans-serif; }
</style>
</head>
<body class="bg-gray-50">
<div class="relative flex min-h-screen w-full flex-col bg-gray-50 overflow-x-hidden">
<header class="sticky top-0 z-10 flex h-16 items-center justify-between whitespace-nowrap border-b border-gray-200 bg-white px-6">
  <div class="flex items-center gap-4 text-gray-800">
    <svg class="h-8 w-8 text-[var(--primary-color)]" fill="none" viewBox="0 0 48 48">
      <path d="M24 18.4L42 11.5V34.4c0 .4-.3.8-.6.9L24 42V18.4Z" fill="currentColor"/>
      <path d="M24 8.2 33.4 11.6 24 15.2 14.6 11.6 24 8.2ZM9 15.8l12 4.6v17.1L9 33V15.8Zm18 21.8V20.5l12-4.6V33l-12 4.6Z" fill="currentColor"/>
    </svg>
    <h2 class="text-lg font-bold">HireXpert</h2>
  </div>
  <a id="back-to-dashboard-link" class="text-sm font-medium text-gray-600 hover:text-[var(--primary-color)]" href="/admin_Dashboard.html">&larr; Back to Dashboard</a>
</header>

<main class="flex-1 px-4 py-10 lg:px-6">
  <div id="loading-state" class="text-center p-10"><p class="text-gray-500">Loading interview details...</p></div>
  <div id="content-container" class="mx-auto max-w-4xl hidden">
    <div class="mb-8">
      <h1 class="text-3xl font-bold tracking-tight">Edit Interview</h1>
      <p id="custom-id-display" class="mt-1 text-base text-gray-500"></p>
    </div>

    <form id="editForm" class="space-y-8">
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
          <div class="p-6 space-y-6">
              <div>
                  <label class="text-sm font-medium text-gray-900" for="title">Interview Title</label>
                  <input id="title" name="title" class="mt-2 w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]" required />
              </div>
              <div>
                  <label class="text-sm font-medium text-gray-900">Created By</label>
                  <p id="created-by-name" class="mt-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-md border"></p>
              </div>
              <div>
                  <label class="text-sm font-medium text-gray-900" for="schedulerIds">Assign Schedulers / Interviewers</label>
                  <select id="schedulerIds" name="schedulerIds" multiple required class="mt-2 w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)] h-32"></select>
              </div>
          </div>
      </div>
      
      <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
          <div class="p-6">
              <h3 class="text-base font-semibold text-gray-900 mb-4">Questions & Time Limits</h3>
              <div id="questions-container" class="space-y-4"></div>
              <button type="button" id="addQuestionBtn" class="mt-4 flex items-center gap-2 rounded-md bg-gray-100 px-3 py-2 text-sm font-medium hover:bg-gray-200">
                <span class="material-symbols-outlined text-base">add</span> Add Question
              </button>
          </div>
      </div>

      <div class="rounded-lg border border-gray-200 bg-white shadow-sm">
        <div class="p-6">
          <h3 class="text-base font-semibold text-gray-900 mb-4">Candidates</h3>
          <div>
            <label class="text-sm font-medium text-gray-700">Currently Invited</label>
            <ul id="current-candidates-list" class="mt-2 space-y-2 text-sm"></ul>
          </div>
          <div class="mt-6">
            <label class="text-sm font-medium text-gray-900" for="new-candidate-emails">Invite More Candidates</label>
            <textarea id="new-candidate-emails" name="newEmails" rows="3" class="mt-2 w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]" placeholder="Enter new candidate emails, separated by commas"></textarea>
            <p class="mt-1 text-xs text-gray-500">Only new emails added here will be sent an invitation.</p>
          </div>
        </div>
      </div>

      <div class="flex justify-between pt-6 mt-8 border-t border-gray-200">
        <button type="button" id="deleteBtn" class="px-4 py-2 rounded-md text-sm font-medium text-red-600 hover:bg-red-50">Delete Interview</button>
        <button type="submit" class="px-6 py-2 rounded-md bg-[var(--primary-color)] text-white font-semibold hover:bg-blue-700">Save Changes</button>
      </div>
    </form>
  </div>
</main>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const interviewId = params.get("id");

  const form = document.getElementById("editForm");
  const questionsContainer = document.getElementById("questions-container");
  const addQuestionBtn = document.getElementById("addQuestionBtn");
  const deleteBtn = document.getElementById("deleteBtn");
  const schedulerSelect = document.getElementById('schedulerIds');
  const candidatesList = document.getElementById('current-candidates-list');

  async function loadSchedulers() {
      try {
          const response = await fetch('/api/users-by-dept');
          if (!response.ok) throw new Error('Failed to load users');
          const users = await response.json();
          schedulerSelect.innerHTML = '';
          users.forEach(user => {
              const option = document.createElement('option');
              option.value = user.id;
              option.textContent = `${user.first_name} ${user.last_name}`;
              schedulerSelect.appendChild(option);
          });
      } catch (error) {
          console.error('Error loading schedulers:', error);
          schedulerSelect.innerHTML = '<option disabled>Error loading users.</option>';
      }
  }
  async function getActiveDepartment() {
    try {
      const res = await fetch('/api/me');
      if (!res.ok) {
        throw new Error('Not authenticated or failed to get session');
      }
      const user = await res.json();
      return user.activeDepartment || null;
    } catch (err) {
      console.error('Failed to get active department:', err);
      return null;
    }
  }

  // Load schedulers from the visitors table filtered by department (uses server's /api/visitors/by-dept)
  async function loadSchedulers(department) {
      try {
          const schedulerSelect = document.getElementById('schedulerIds');
          schedulerSelect.innerHTML = '<option disabled>Loading reviewers...</option>';

          if (!department) {
              schedulerSelect.innerHTML = '<option disabled>Please select an interview department first.</option>';
              return;
          }

          const response = await fetch(`/api/visitors/by-dept?department=${encodeURIComponent(department)}`);
          if (!response.ok) {
              if (response.status === 401) throw new Error('Your session may have expired. Please log in again.');
              throw new Error('Failed to load reviewers for this department.');
          }

          const visitors = await response.json();
          schedulerSelect.innerHTML = ''; // clear

          if (!Array.isArray(visitors) || visitors.length === 0) {
              schedulerSelect.innerHTML = `<option disabled>No reviewers found for ${department}.</option>`;
              return;
          }

          visitors.forEach(visitor => {
              const option = document.createElement('option');
              option.value = visitor.id; // visitor id
              // show name and email so schedulers are easy to pick
              const name = `${visitor.first_name || ''} ${visitor.last_name || ''}`.trim();
              option.textContent = name ? `${name} ‚Äî ${visitor.email}` : visitor.email;
              schedulerSelect.appendChild(option);
          });
      } catch (error) {
          console.error('Error loading schedulers (visitors):', error);
          const schedulerSelect = document.getElementById('schedulerIds');
          if (schedulerSelect) schedulerSelect.innerHTML = '<option disabled>Error loading reviewers.</option>';
      }
  }

  // Modified loadInterview to fetch department first, then load schedulers (visitors), then fetch interview
  async function loadInterview() {
    try {
      // 1) Get active department and load visitors (schedulers) for it
      const activeDept = await getActiveDepartment();
      await loadSchedulers(activeDept);

      // 2) Then fetch the interview itself
      const res = await fetch(`/api/interview/${interviewId}`);
      if (!res.ok) throw new Error('Interview not found');
      const interview = await res.json();

      // 3) Populate form fields (unchanged)
      document.getElementById("title").value = interview.title || '';
      document.getElementById("custom-id-display").textContent = `Editing Interview ID: ${interview.custom_interview_id || ''}`;
      document.getElementById("created-by-name").textContent = `${interview.first_name || ''} ${interview.last_name || ''}`.trim() || 'N/A';

      // 4) Pre-select assigned schedulers (scheduler_ids should now match visitor IDs)
      const schedulerIds = new Set(interview.visitor_reviewer_ids || []);
      Array.from(schedulerSelect.options).forEach(option => {
          // option.value is a string; ensure types match
          if (schedulerIds.has(option.value) || schedulerIds.has(option.value.toString())) {
              option.selected = true;
          } else {
              option.selected = false;
          }
      });

      // 5) Populate current candidates
      candidatesList.innerHTML = '';
      if (interview.candidates && interview.candidates.length > 0) {
        interview.candidates.forEach(c => {
          const li = document.createElement('li');
          li.className = 'p-2 bg-gray-50 border rounded-md';
          li.textContent = c.candidate_email;
          candidatesList.appendChild(li);
        });
      } else {
        candidatesList.innerHTML = '<li class="text-gray-500 italic">No candidates have been invited yet.</li>';
      }

      // 6) Populate questions (existing addQuestion function can be used)
      questionsContainer.innerHTML = "";
      const questions = interview.questions || [];
      const timeLimits = interview.time_limits || [];
      questions.forEach((q, i) => addQuestion(q, timeLimits[i] || 0));

      document.getElementById('loading-state').style.display = 'none';
      document.getElementById('content-container').classList.remove('hidden');

    } catch (err) {
      console.error("Error loading interview:", err);
      document.getElementById('loading-state').innerHTML = `<p class="text-red-500">Failed to load interview. ${err.message}</p>`;
    }
  }

  // Call loadInterview() on page load (it will call the visitors-by-dept route first)
  document.addEventListener('DOMContentLoaded', () => {
    if (interviewId) {
      loadInterview();
    } else {
      document.getElementById('loading-state').innerHTML = '<p class="text-red-500">No interview id provided in URL.</p>';
    }
  });

  function addQuestion(value = "", timeLimit = 0) {
    const div = document.createElement("div");
    div.classList.add("flex", "items-start", "gap-4");
    div.innerHTML = `
      <textarea class="w-full rounded-md border border-gray-300 bg-white p-3 text-sm flex-1 resize-y min-h-24" placeholder="Enter your question here" required>${value}</textarea>
      <select class="w-28 rounded-md border-gray-300 bg-white p-2 text-sm h-12">
          <option value="0">Untimed</option>
          <option value="60">60s</option>
          <option value="90">90s</option>
          <option value="120">120s</option>
          <option value="150">150s</option>
          <option value="180">180s</option>
      </select>
      <button type="button" class="removeBtn flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-md bg-gray-100 text-gray-600 hover:bg-red-50 hover:text-red-600">
        <span class="material-symbols-outlined text-xl">delete</span>
      </button>
    `;
    div.querySelector("select").value = timeLimit;
    div.querySelector(".removeBtn").onclick = () => div.remove();
    questionsContainer.appendChild(div);
  }

  addQuestionBtn.onclick = () => addQuestion();

  form.onsubmit = async (e) => {
    e.preventDefault();

    const questions = [];
    const timeLimits = [];

    questionsContainer.querySelectorAll("div").forEach(div => {
      questions.push(div.querySelector("textarea").value);
      timeLimits.push(parseInt(div.querySelector("select").value) || 0);
    });
    
    const selectedSchedulerIds = Array.from(schedulerSelect.selectedOptions).map(opt => opt.value);

    const payload = {
      title: form.title.value,
      questions,
      timeLimits,
      visitorReviewerIds: selectedSchedulerIds,
      newEmails: form.newEmails.value,
    };

    try {
      const res = await fetch(`/api/interview/${interviewId}/update`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });
      const result = await res.json();
      if (res.ok) {
        alert("‚úÖ Interview updated successfully!");
        window.location.href = document.getElementById('back-to-dashboard-link').href;
      } else {
        throw new Error(result.message);
      }
    } catch (err) {
      console.error("Error updating interview:", err);
      alert("‚ùå Failed to update interview: " + err.message);
    }
  };

  deleteBtn.onclick = async () => {
    if (!confirm("Are you sure you want to delete this interview? This will delete all associated candidate data and cannot be undone.")) return;
    try {
      const res = await fetch(`/api/interview/${interviewId}/delete`, { method: "DELETE" });
      const result = await res.json();
      if (res.ok) {
        alert("üóëÔ∏è Interview deleted.");
        window.location.href = document.getElementById('back-to-dashboard-link').href;
      } else {
        throw new Error(result.message);
      }
    } catch (err) {
      console.error("Error deleting interview:", err);
      alert("‚ùå Failed to delete interview: " + err.message);
    }
  };
  
  // Set the back link dynamically based on the 'from' URL parameter
  const fromDashboard = params.get('from');
  if(fromDashboard){
      document.getElementById('back-to-dashboard-link').href = `/${fromDashboard}`;
  }

  loadInterview();
</script>
</body>
</html>