<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Edit Profile - Dvar</title>
    <link rel="icon" type="image/png" href="/LoginTest/public/assets/favicon.png">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
      :root {
        --primary-color: #2563eb; /* Tailwind blue-600 */
        --primary-600: #2563eb; /* For consistency */
        --text-primary: #111418;
        --text-secondary: #617589;
      }
      body { font-family: 'Inter', sans-serif; }
      .modal-hidden { display: none; }
      /* Notification Modal Styles */
      #notification-modal { transition: opacity 0.3s ease-out; }
      #notification-modal > div { transition: all 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex min-h-screen w-full flex-col">

    <!-- Header -->
    <header class="flex shrink-0 items-center justify-between border-b border-gray-200 bg-white px-6 py-3">
        <div class="flex items-center gap-6">
          <div class="flex items-center gap-3 text-gray-800">
            <svg class="h-8 w-8 text-primary-600" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_6_319)"><path d="M8.57829 8.57829C5.52816 11.6284 3.451 15.5145 2.60947 19.7452C1.76794 23.9758 2.19984 28.361 3.85056 32.3462C5.50128 36.3314 8.29667 39.7376 11.8832 42.134C15.4698 44.5305 19.6865 45.8096 24 45.8096C28.3135 45.8096 32.5302 44.5305 36.1168 42.134C39.7033 39.7375 42.4987 36.3314 44.1494 32.3462C45.8002 28.361 46.2321 23.9758 45.3905 19.7452C44.549 15.5145 42.4718 11.6284 39.4217 8.57829L24 24L8.57829 8.57829Z" fill="currentColor"></path></g><defs><clipPath id="clip0_6_319"><rect fill="white" height="48" width="48"></rect></clipPath></defs></svg>
            <h1 class="text-xl font-bold text-gray-900">Dvar</h1>
          </div>
          <!-- Simple Back Link (Update dynamically if needed) -->
          <a id="back-link" href="#" class="text-sm font-medium text-gray-600 hover:text-primary-600">&larr; Back to Dashboard</a>
        </div>
        <div class="flex items-center gap-4">
          <button class="relative rounded-full p-2 hover:bg-gray-100">
            <span class="material-symbols-outlined text-gray-600">notifications</span>
          </button>
          <!-- Profile Picture Dropdown -->
          <div class="relative">
              <button id="profile-menu-button" type="button" class="flex rounded-full bg-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                  <span class="sr-only">Open user menu</span>
                  <div class="h-9 w-9 rounded-full bg-gray-300 flex items-center justify-center overflow-hidden">
                       <span id="profile-initials" class="text-sm font-medium text-gray-600"></span>
                  </div>
              </button>
              <div id="profile-menu-dropdown" class="hidden absolute right-0 z-10 mt-2 w-56 origin-top-right rounded-md bg-white py-1 shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu" aria-orientation="vertical" aria-labelledby="profile-menu-button" tabindex="-1">
                   <div class="border-b border-gray-200 px-4 py-3 text-sm"> <p class="font-medium text-gray-900">Signed in as</p> <p id="user-email-display" class="truncate text-gray-500">Loading...</p> </div>
                   <div class="py-1" role="none"> <a href="/settings.html" class="block px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50" role="menuitem" tabindex="-1" id="user-menu-item-profile">Edit Profile</a> </div>
                   <div class="py-1" role="none"> <a href="/logout" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem" tabindex="-1" id="user-menu-item-logout">Sign out</a> </div>
              </div>
          </div>
        </div>
      </header>

    <!-- Main Content Area -->
    <main class="flex-1 px-4 py-10 lg:px-6">
        <div class="mx-auto max-w-2xl">
            <h2 class="text-3xl font-bold tracking-tight text-gray-900 mb-8">Edit Your Profile</h2>

            <div id="loading-state" class="text-center p-10"><p class="text-gray-500">Loading profile...</p></div>
            <div id="error-state" class="hidden text-center p-10 bg-red-50 rounded-lg"><p class="text-red-600 font-medium">Could not load profile.</p><p id="error-message" class="text-red-500 text-sm mt-2"></p></div>

            <form id="profileForm" class="hidden rounded-lg border border-gray-200 bg-white shadow-sm">
                <div class="space-y-6 p-6 md:p-8">
                    <!-- Name Fields -->
                    <div class="grid grid-cols-1 gap-x-6 gap-y-6 sm:grid-cols-6">
                        <div class="sm:col-span-3">
                            <label for="firstName" class="block text-sm font-medium leading-6 text-gray-900">First name</label>
                            <div class="mt-2">
                                <input type="text" name="firstName" id="firstName" autocomplete="given-name" required class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                            </div>
                        </div>
                        <div class="sm:col-span-3">
                            <label for="lastName" class="block text-sm font-medium leading-6 text-gray-900">Last name</label>
                            <div class="mt-2">
                                <input type="text" name="lastName" id="lastName" autocomplete="family-name" required class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                            </div>
                        </div>
                    </div>

                    <!-- Email Field -->
                    <div>
                        <label for="email" class="block text-sm font-medium leading-6 text-gray-900">Email address</label>
                        <div class="mt-2">
                            <input id="email" name="email" type="email" autocomplete="email" required class="block w-full rounded-md border-0 py-2 px-3 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6">
                        </div>
                    </div>

                <!-- Password Field -->
                <div>
                <label for="password" class="block text-sm font-medium leading-6 text-gray-900">
                    New Password (Optional)
                </label>

                <div class="mt-2 relative">
                    <input
                    type="password"
                    name="password"
                    id="password"
                    autocomplete="new-password"
                    maxlength="20"
                    class="block w-full rounded-md border-0 py-2 px-3 pr-36 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 sm:text-sm sm:leading-6"
                    placeholder="Leave blank to keep current password"
                    />

                    <!-- View / Hide Password -->
                    <button
                    type="button"
                    id="toggle-password-btn"
                    class="absolute right-28 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-700"
                    title="Show / Hide Password"
                    >
                    <span class="material-symbols-outlined text-xl">visibility</span>
                    </button>

                    <!-- Generate Password -->
                    <button
                    type="button"
                    id="generate-password-btn"
                    class="absolute right-2 top-1/2 -translate-y-1/2 rounded-md bg-gray-100 px-3 py-1 text-xs font-semibold text-gray-700 hover:bg-gray-200"
                    >
                    Generate
                    </button>
                </div>

                <!-- Password Rules -->
                <ul id="password-rules" class="mt-2 text-xs text-gray-500 space-y-1">
                    <li data-rule="length">• 8–20 characters</li>
                    <li data-rule="uppercase">• At least 1 uppercase letter</li>
                    <li data-rule="number">• At least 1 number</li>
                    <li data-rule="special">• At least 1 special character</li>
                </ul>

                <p id="password-error" class="mt-1 text-xs text-red-600 hidden">
                    Password does not meet the required complexity.
                </p>
                </div>


                <!-- Form Actions -->
                <div class="flex items-center justify-end gap-x-6 border-t border-gray-900/10 bg-gray-50 px-6 py-4">
                    <button type="button" id="cancelButton" class="text-sm font-semibold leading-6 text-gray-900">Cancel</button>
                    <button type="submit" id="saveButton" class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 disabled:opacity-50">
                        Save Profile
                    </button>
                </div>
            </form>
        </div>
    </main>
</div>

<!-- Notification Modal HTML -->
<div id="notification-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75 transition-opacity duration-300 ease-out opacity-0">
    <div class="w-full max-w-sm transform rounded-lg bg-white p-6 shadow-xl text-center transition-all duration-300 ease-out scale-95 opacity-0"
         role="alertdialog" aria-modal="true" aria-labelledby="notification-modal-title">
        <div id="notification-modal-icon" class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100">
             <span class="material-symbols-outlined text-3xl text-green-600">check_circle</span>
        </div>
        <h3 id="notification-modal-title" class="mt-4 text-lg font-medium text-gray-900">Success!</h3>
        <div class="mt-2">
            <p id="notification-modal-text" class="text-sm text-gray-500">Your action was completed successfully.</p>
        </div>
        <div id="notification-modal-buttons" class="mt-5 sm:mt-6">
            <!-- Buttons dynamically added -->
        </div>
    </div>
</div>

<script>

    // ---------------- PASSWORD COMPLEXITY LOGIC ----------------
    const passwordInput = document.getElementById('password');
    const passwordError = document.getElementById('password-error');
    const saveBtn = document.getElementById('saveButton');
    const generateBtn = document.getElementById('generate-password-btn');
    const rulesList = document.querySelectorAll('#password-rules li');

    const PASSWORD_REGEX = {
    length: /^.{8,20}$/,
    uppercase: /[A-Z]/,
    number: /[0-9]/,
    special: /[^A-Za-z0-9]/
    };

    function validatePassword(password) {
    if (!password) return true; // Optional password

    return (
        PASSWORD_REGEX.length.test(password) &&
        PASSWORD_REGEX.uppercase.test(password) &&
        PASSWORD_REGEX.number.test(password) &&
        PASSWORD_REGEX.special.test(password)
    );
    }

    function updatePasswordUI(password) {
    const checks = {
        length: PASSWORD_REGEX.length.test(password),
        uppercase: PASSWORD_REGEX.uppercase.test(password),
        number: PASSWORD_REGEX.number.test(password),
        special: PASSWORD_REGEX.special.test(password)
    };

    rulesList.forEach(li => {
        const rule = li.dataset.rule;
        if (checks[rule]) {
        li.classList.add('text-green-600');
        li.classList.remove('text-gray-500');
        } else {
        li.classList.remove('text-green-600');
        li.classList.add('text-gray-500');
        }
    });

    const isValid = validatePassword(password);

    if (!isValid && password.length > 0) {
        passwordError.classList.remove('hidden');
        saveBtn.disabled = true;
    } else {
        passwordError.classList.add('hidden');
        saveBtn.disabled = false;
    }
    }

    // Real-time validation
    passwordInput.addEventListener('input', (e) => {
    updatePasswordUI(e.target.value);
    });

    // ---------------- PASSWORD GENERATOR ----------------

    function generateStrongPassword() {
    const upper = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    const lower = "abcdefghijklmnopqrstuvwxyz";
    const numbers = "0123456789";
    const specials = "!@#$%^&*()_+-=[]{}|;:,.<>?";

    const all = upper + lower + numbers + specials;

    let password = [
        upper[Math.floor(Math.random() * upper.length)],
        numbers[Math.floor(Math.random() * numbers.length)],
        specials[Math.floor(Math.random() * specials.length)]
    ];

    while (password.length < 12) {
        password.push(all[Math.floor(Math.random() * all.length)]);
    }

    // Shuffle
    password = password.sort(() => Math.random() - 0.5).join('');

    return password.substring(0, 20);
    }

    generateBtn.addEventListener('click', () => {
    const pwd = generateStrongPassword();
    passwordInput.value = pwd;
    updatePasswordUI(pwd);
    });

    // ---------------- VIEW / HIDE PASSWORD ----------------

    const togglePasswordBtn = document.getElementById('toggle-password-btn');
    const passwordField = document.getElementById('password');
    const toggleIcon = togglePasswordBtn.querySelector('span');

    let isPasswordVisible = false;

    togglePasswordBtn.addEventListener('click', () => {
    isPasswordVisible = !isPasswordVisible;

    passwordField.type = isPasswordVisible ? 'text' : 'password';
    toggleIcon.textContent = isPasswordVisible ? 'visibility_off' : 'visibility';
});

    // --- Global variables ---
    let originalUserEmail = ''; // To track if email changes
    let activeDashboardUrl = '/admin_Dashboard.html'; // Default back link

    // --- Notification Modal Helpers ---
    const notificationModal = document.getElementById('notification-modal');
    const notificationDialog = notificationModal ? notificationModal.querySelector('[role="alertdialog"]') : null;

    const showModal = () => {
      if (!notificationModal || !notificationDialog) return;
      notificationModal.classList.remove('hidden');
      setTimeout(() => {
        notificationModal.classList.add('opacity-100');
        notificationDialog.classList.remove('scale-95', 'opacity-0');
        notificationDialog.classList.add('scale-100', 'opacity-100');
      }, 10);
    };
    const hideModal = () => {
      if (!notificationModal || !notificationDialog) return;
      notificationModal.classList.remove('opacity-100');
      notificationDialog.classList.remove('scale-100', 'opacity-100');
      notificationDialog.classList.add('scale-95', 'opacity-0');
      setTimeout(() => {
        notificationModal.classList.add('hidden');
      }, 300);
    };

    // --- Utility and Notification Function ---
    function showNotification(title, text, options = {}) {
        const { isError = false, onConfirm = null, confirmText = 'Confirm', cancelText = 'Cancel', duration = null } = options;
        const modalTitle = document.getElementById('notification-modal-title');
        const modalText = document.getElementById('notification-modal-text');
        const modalIcon = document.getElementById('notification-modal-icon');
        const btnContainer = document.getElementById('notification-modal-buttons');

        if (!notificationModal || !modalTitle || !modalText || !modalIcon || !btnContainer) {
            alert(`${title}: ${text}`); return;
        }
        modalTitle.textContent = title;
        modalText.textContent = text;
        if (isError) { modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-red-600">error</span>`; modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100"; }
        else { modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-green-600">check_circle</span>`; modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100"; }
        btnContainer.innerHTML = '';
        if (onConfirm) {
            btnContainer.className = 'mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3';
            const confirmBtn = document.createElement('button');
            confirmBtn.type = 'button';
            confirmBtn.className = isError ? 'inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2' : 'inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:col-start-2';
            confirmBtn.textContent = confirmText;
            confirmBtn.onclick = () => { hideModal(); onConfirm(); };
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.className = 'mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0';
            cancelBtn.textContent = cancelText;
            cancelBtn.onclick = () => { hideModal(); };
            btnContainer.appendChild(cancelBtn);
            btnContainer.appendChild(confirmBtn);
        } else {
            btnContainer.className = 'mt-5 sm:mt-6';
            if (duration === null || duration <= 0) {
                const okBtn = document.createElement('button');
                okBtn.type = 'button';
                okBtn.className = 'inline-flex w-full justify-center rounded-md bg-[var(--primary-color)] px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-opacity-90';
                okBtn.textContent = 'Got it';
                okBtn.onclick = () => { hideModal(); };
                btnContainer.appendChild(okBtn);
            }
        }
        showModal();
        if (duration > 0 && !onConfirm) { setTimeout(() => { hideModal(); }, duration); }
    }

    // --- Profile Dropdown & User Info ---
    const profileButton = document.getElementById('profile-menu-button');
    const profileDropdown = document.getElementById('profile-menu-dropdown');
    const profileInitials = document.getElementById('profile-initials');
    const userEmailDisplay = document.getElementById('user-email-display');
    const backLink = document.getElementById('back-link');

    async function fetchUserInfoForHeader() {
        try {
            const response = await fetch('/api/me'); // Use the basic /api/me for header
            if (!response.ok) {
                if (response.status === 401) window.location.href = '/'; // Redirect if not logged in
                else throw new Error(`HTTP error! status: ${response.status}`);
                return null; // Return null if redirecting or error
            }
            const user = await response.json();

            // Update header elements
            if (userEmailDisplay) userEmailDisplay.textContent = user.email || 'Error';
            if (profileInitials && user.email) profileInitials.textContent = user.email.substring(0, 1).toUpperCase();

            // Set back link based on active department
            if (user.activeDepartment && backLink) {
                 activeDashboardUrl = `/${user.activeDepartment}_Dashboard.html`;
                 backLink.href = activeDashboardUrl;
            } else if (backLink) {
                 // Fallback if department isn't available for some reason
                 backLink.href = '/admin_Dashboard.html';
            }
            return user; // Return user data for potential use elsewhere

        } catch (error) {
            console.error("Failed to fetch user info for header:", error);
            if (userEmailDisplay) userEmailDisplay.textContent = 'Error';
            return null; // Return null on error
        }
    }

    // --- Load Profile Data for Form ---
    async function loadProfileData() {
        const loadingDiv = document.getElementById('loading-state');
        const errorDiv = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');
        const formDiv = document.getElementById('profileForm');

        try {
            const response = await fetch('/api/me/details'); // Fetch detailed info
            if (!response.ok) {
                 if (response.status === 401) { window.location.href = '/'; return; } // Redirect if unauthorized
                 const errData = await response.json();
                 throw new Error(errData.message || `HTTP error ${response.status}`);
            }
            const user = await response.json();

            // Pre-fill the form
            document.getElementById('firstName').value = user.first_name || '';
            document.getElementById('lastName').value = user.last_name || '';
            document.getElementById('email').value = user.email || '';
            originalUserEmail = user.email || ''; // Store original email

            // Hide loading, show form
            loadingDiv.style.display = 'none';
            formDiv.classList.remove('hidden');

        } catch (error) {
            console.error("Failed to load profile data:", error);
            loadingDiv.style.display = 'none';
            errorMessage.textContent = error.message;
            errorDiv.classList.remove('hidden');
        }
    }


    // --- Form Submission Handler ---
    const profileForm = document.getElementById('profileForm');
    const saveButton = document.getElementById('saveButton');

    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        saveButton.disabled = true; // Prevent double-clicks
        saveButton.textContent = 'Saving...';

        const formData = new FormData(profileForm);
        const data = {
            firstName: formData.get('firstName'),
            lastName: formData.get('lastName'),
            email: formData.get('email'),
            password: formData.get('password') // Send password field (backend handles if it's empty)
        };

        try {
            const response = await fetch('/api/me/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.message || `Failed to update profile. Status: ${response.status}`);
            }

            showNotification('Success!', 'Profile updated successfully.', { duration: 3000 });
            // Optionally clear password field after successful save
            document.getElementById('password').value = '';
             // Update header email if it changed
            if (originalUserEmail !== data.email) {
                 fetchUserInfoForHeader(); // Re-fetch header info
                 originalUserEmail = data.email; // Update stored email
            }


        } catch (error) {
            console.error("Error updating profile:", error);
            showNotification('Error', error.message, { isError: true });
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'Save Profile';
        }
    });

    // --- Cancel Button ---
     const cancelButton = document.getElementById('cancelButton');
     cancelButton.addEventListener('click', () => {
         // Redirect back to the determined active dashboard URL
         window.location.href = backLink.href || '/admin_Dashboard.html';
     });


    // --- Initialize Page ---
    document.addEventListener('DOMContentLoaded', () => {
        // Setup profile dropdown listeners
        if (profileButton && profileDropdown) {
            profileButton.addEventListener('click', (e) => {
                e.stopPropagation();
                profileDropdown.classList.toggle('hidden');
            });
            document.addEventListener('click', (event) => {
                if (profileButton && profileDropdown && !profileButton.contains(event.target) && !profileDropdown.contains(event.target)) {
                    profileDropdown.classList.add('hidden');
                }
            });
        }
        // Fetch header info first to set back link
        fetchUserInfoForHeader().then(() => {
            // Then load the main profile data for the form
            loadProfileData();
        });
    });

</script>

</body>
</html>
