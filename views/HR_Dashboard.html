<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>HireXpert- HR Interviews</title>
<link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
<link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<style type="text/tailwindcss">
      :root {
        --primary-50: #eff6ff;
        --primary-600: #2563eb;
        --gray-500: #6b7280;
        --info-50: #ecfeff;
        --info-500: #06b6d4;
      }
      .material-symbols-outlined {
        font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
      }
      #create-interview-btn {
        background-color: var(--primary-600) !important;
        color: white !important;
      }
      .tab-active {
        border-bottom-color: var(--primary-600);
        color: var(--primary-600);
        font-weight: 600;
      }
      .modal-hidden { display: none; }
</style>
</head>
<body class="bg-gray-50" style='font-family: "Inter", "Noto Sans", sans-serif;'>
<div class="flex min-h-screen w-full flex-col">

  <header class="flex shrink-0 items-center justify-between border-b border-gray-200 bg-white px-6 py-3">
    <div class="flex items-center gap-6">
      <div class="flex items-center gap-3 text-gray-800">
        <svg class="h-8 w-8 text-primary-600" fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_6_319)"><path d="M8.57829 8.57829C5.52816 11.6284 3.451 15.5145 2.60947 19.7452C1.76794 23.9758 2.19984 28.361 3.85056 32.3462C5.50128 36.3314 8.29667 39.7376 11.8832 42.134C15.4698 44.5305 19.6865 45.8096 24 45.8096C28.3135 45.8096 32.5302 44.5305 36.1168 42.134C39.7033 39.7375 42.4987 36.3314 44.1494 32.3462C45.8002 28.361 46.2321 23.9758 45.3905 19.7452C44.549 15.5145 42.4718 11.6284 39.4217 8.57829L24 24L8.57829 8.57829Z" fill="currentColor"></path></g><defs><clipPath id="clip0_6_319"><rect fill="white" height="48" width="48"></rect></clipPath></defs></svg>
        <h1 class="text-xl font-bold text-gray-900">HireXpert</h1>
      </div>
      <nav class="hidden md:flex items-center gap-4">
        <a class="rounded-md px-3 py-2 text-sm font-medium text-primary-600 bg-primary-50" href="#">Interviews</a>
        <a class="rounded-md px-3 py-2 text-sm font-medium text-gray-600 hover:bg-gray-100 hover:text-gray-900 transition-colors" href="/candidates.html?department=HR">Candidates</a>
      </nav>
    </div>
    <div class="flex items-center gap-4">
      <div class="relative w-full max-w-xs">
        <span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-gray-400">search</span>
        <input id="search-bar" class="form-input w-full rounded-md border-gray-300 bg-white pl-10 text-sm focus:border-primary-500 focus:ring-primary-500" placeholder="Search by title or ID..."/>
      </div>
      <button class="relative rounded-full p-2 hover:bg-gray-100">
        <span class="material-symbols-outlined text-gray-600">notifications</span>
      </button>
      <div class="h-9 w-9 rounded-full bg-cover bg-center" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuCNctMQZk057P4bZQyXOoQ8_ftfJSJig5XgqMo5Mr3D_o9DZ5n5kCInWe5TIfW-ulGx3VYTOsKo1EzETBKi8RNVx98zI9JS__wtG0yh14icatZqcW8tTAP2oUhIRqCGZd_A9V9ic2qKuRy3osm7X3mYNvepkxopJ8EnrXL11wsiyIS4OLG8pkEGjr6OUdBWUBiNlyNWo3fzOb_bgDq9IWQcZepr9dApJMfHAFG_GsHmOeXRzvi8Qrxt_RU3OilP0PEXxof-wZQcJos");'></div>
    </div>
  </header>

  <main class="flex-1 px-8 py-8 md:px-12 lg:px-16">
    <div class="mx-auto max-w-7xl">
      <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
        <h2 class="text-3xl font-bold text-gray-900">HR Interviews</h2>
        <button id="create-interview-btn" onclick="window.location.href='/schedule.html?from=HR_Dashboard.html'" class="flex items-center gap-2 rounded-md bg-primary-600 px-4 py-2.5 text-sm font-semibold text-white shadow-sm hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2">
          <span class="material-symbols-outlined">add</span>
          <span>Create Interview</span>
        </button>
      </div>

      <div class="border-b border-gray-200 mb-6">
          <nav class="-mb-px flex space-x-6" aria-label="Tabs">
              <button id="open-positions-tab" class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm tab-active">
                  Open Positions <span id="open-count" class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary-50 text-primary-600">0</span>
              </button>
              <button id="closed-positions-tab" class="whitespace-nowrap py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300">
                  Closed Positions <span id="closed-count" class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">0</span>
              </button>
          </nav>
      </div>

      <div id="bulk-actions-bar" class="hidden mb-4 rounded-md bg-primary-50 p-3 flex items-center justify-between">
          <p class="text-sm font-medium text-primary-700"><span id="selected-count">0</span> interviews selected</p>
          <div>
              <button id="move-to-closed-btn" class="mr-2 rounded-md bg-white px-3 py-1.5 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Move to Closed</button>
              <button id="move-to-open-btn" class="hidden mr-2 rounded-md bg-white px-3 py-1.5 text-sm font-semibold text-gray-700 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50">Re-open Positions</button>
              <button id="delete-selected-btn" class="rounded-md bg-red-600 px-3 py-1.5 text-sm font-semibold text-white shadow-sm hover:bg-red-500">Delete</button>
          </div>
      </div>

      <div class="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="relative px-6 py-3"><input type="checkbox" id="select-all-checkbox" class="h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500"></th>
              <th class="px-4 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">S.No.</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">ID</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Title</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Invited</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">To Evaluate</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Evaluated</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Discarded</th>
              <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500" scope="col">Actions</th>
            </tr>
          </thead>
          <tbody id="interviews-table-body" class="divide-y divide-gray-200 bg-white"></tbody>
        </table>
      </div>
    </div>
  </main>
</div>

<div id="confirm-modal" class="modal-hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50">
    <div class="w-full max-w-sm transform rounded-lg bg-white p-6 shadow-xl">
        <h3 id="confirm-modal-title" class="text-lg font-medium text-gray-900">Are you sure?</h3>
        <div class="mt-2">
            <p id="confirm-modal-text" class="text-sm text-gray-500">This action cannot be undone.</p>
        </div>
        <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
            <button id="confirm-modal-confirm-btn" type="button" class="inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2">Confirm</button>
            <button id="confirm-modal-cancel-btn" type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0">Cancel</button>
        </div>
    </div>
</div>

<script>
  let currentStatusFilter = 'open';
  let selectedInterviewIds = new Set();
  const DEPARTMENT = 'HR';
  
  // Cache for storing fetched interviews
  let allInterviews = [];

  async function loadCounts() {
      try {
          const res = await fetch(`/api/interviews/counts?department=${DEPARTMENT}`);
          const counts = await res.json();
          document.getElementById('open-count').textContent = counts.open || 0;
          document.getElementById('closed-count').textContent = counts.closed || 0;
      } catch (err) { console.error("Error loading counts:", err); }
  }

  // New function to render the table based on search term
  function renderTable(searchTerm = '') {
    const tbody = document.querySelector("#interviews-table-body");
    tbody.innerHTML = "";

    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    const filteredInterviews = allInterviews.filter(interview => {
        const titleMatch = interview.title.toLowerCase().includes(lowerCaseSearchTerm);
        const idMatch = interview.custom_interview_id ? interview.custom_interview_id.toLowerCase().includes(lowerCaseSearchTerm) : false;
        return titleMatch || idMatch;
    });

    if (filteredInterviews.length === 0) {
        tbody.innerHTML = `<tr><td colspan="9" class="text-center py-10 text-gray-500">No ${searchTerm ? 'matching' : currentStatusFilter} interviews found.</td></tr>`;
        return;
    }

    filteredInterviews.forEach((interview, index) => {
        const tr = document.createElement("tr");
        const isSelected = selectedInterviewIds.has(interview.id);
        tr.innerHTML = `
            <td class="relative px-6 py-4"><input type="checkbox" data-id="${interview.id}" class="row-checkbox h-4 w-4 rounded border-gray-300 text-primary-600 focus:ring-primary-500" ${isSelected ? 'checked' : ''}></td>
            <td class="px-4 py-4 text-sm text-gray-500">${index + 1}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${interview.custom_interview_id || 'N/A'}</td>
            <td class="px-6 py-4"><a href="/interview-view.html?id=${interview.id}" class="font-medium text-gray-900 hover:text-primary-600">${interview.title}</a></td>
            <td class="px-6 py-4"><span class="inline-flex items-center rounded-md bg-yellow-100 px-2.5 py-1 text-sm font-semibold text-yellow-800">5</span></td>
            <td class="px-6 py-4"><span class="inline-flex items-center rounded-md bg-amber-100 px-2.5 py-1 text-sm font-semibold text-amber-800">2</span></td>
            <td class="px-6 py-4"><span class="inline-flex items-center rounded-md bg-green-100 px-2.5 py-1 text-sm font-semibold text-green-800">1</span></td>
            <td class="px-6 py-4"><span class="inline-flex items-center rounded-md bg-red-100 px-2.5 py-1 text-sm font-semibold text-red-800">0</span></td>
            <td class="whitespace-nowrap px-6 py-4 text-sm font-medium">
                <a href="/interview-view.html?id=${interview.id}" class="text-primary-600 hover:text-primary-900">View</a>
                <a href="/interview-edit.html?id=${interview.id}" class="ml-4 text-primary-600 hover:text-primary-900">Edit</a>
            </td>
        `;
        tbody.appendChild(tr);
    });
  }

  // Renamed function to fetch data and then call render
  async function fetchAndRenderInterviews() {
    try {
      const url = `/api/interviews?department=${DEPARTMENT}&position_status=${currentStatusFilter}`;
      const res = await fetch(url);
      allInterviews = await res.json(); 
      const searchBar = document.getElementById('search-bar');
      renderTable(searchBar.value);
    } catch (err) { console.error("Error loading interviews:", err); }
  }
  
  function updateBulkActionBar() {
    const bar = document.getElementById('bulk-actions-bar');
    const countSpan = document.getElementById('selected-count');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const moveToClosedBtn = document.getElementById('move-to-closed-btn');
    const moveToOpenBtn = document.getElementById('move-to-open-btn');

    if (selectedInterviewIds.size > 0) {
        bar.classList.remove('hidden');
        countSpan.textContent = selectedInterviewIds.size;
        
        if (currentStatusFilter === 'open') {
            moveToClosedBtn.classList.remove('hidden');
            moveToOpenBtn.classList.add('hidden');
        } else {
            moveToClosedBtn.classList.add('hidden');
            moveToOpenBtn.classList.remove('hidden');
        }
        
        selectAllCheckbox.checked = selectedInterviewIds.size === rowCheckboxes.length && rowCheckboxes.length > 0 && allInterviews.length > 0;
    } else {
        bar.classList.add('hidden');
        selectAllCheckbox.checked = false;
    }
  }

  const confirmModal = document.getElementById('confirm-modal');
  let confirmCallback = null;

  function showConfirmModal(title, text, onConfirm) {
      document.getElementById('confirm-modal-title').textContent = title;
      document.getElementById('confirm-modal-text').textContent = text;
      confirmCallback = onConfirm;
      confirmModal.classList.remove('modal-hidden');
  }

  function hideConfirmModal() {
      confirmModal.classList.add('modal-hidden');
      confirmCallback = null;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const openTab = document.getElementById('open-positions-tab');
    const closedTab = document.getElementById('closed-positions-tab');
    const searchBar = document.getElementById('search-bar');
    const tableBody = document.getElementById('interviews-table-body');
    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const moveToClosedBtn = document.getElementById('move-to-closed-btn');
    const moveToOpenBtn = document.getElementById('move-to-open-btn');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');
    const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
    const cancelBtn = document.getElementById('confirm-modal-cancel-btn');

    confirmBtn.addEventListener('click', () => {
        if (typeof confirmCallback === 'function') confirmCallback();
        hideConfirmModal();
    });
    cancelBtn.addEventListener('click', hideConfirmModal);

    function switchTab(newStatus) {
        currentStatusFilter = newStatus;
        openTab.classList.toggle('tab-active', newStatus === 'open');
        closedTab.classList.toggle('tab-active', newStatus === 'closed');
        fetchAndRenderInterviews();
        selectedInterviewIds.clear();
        updateBulkActionBar();
    }

    openTab.addEventListener('click', () => switchTab('open'));
    closedTab.addEventListener('click', () => switchTab('closed'));
    
    tableBody.addEventListener('change', (e) => {
        if (e.target.classList.contains('row-checkbox')) {
            const id = e.target.dataset.id;
            if (e.target.checked) selectedInterviewIds.add(id);
            else selectedInterviewIds.delete(id);
            updateBulkActionBar();
        }
    });

    selectAllCheckbox.addEventListener('change', (e) => {
        const checkboxes = tableBody.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => {
            cb.checked = e.target.checked;
            const id = cb.dataset.id;
            if (e.target.checked) selectedInterviewIds.add(id);
            else selectedInterviewIds.delete(id);
        });
        updateBulkActionBar();
    });

    moveToClosedBtn.addEventListener('click', () => {
        showConfirmModal(
            `Move ${selectedInterviewIds.size} interviews?`,
            "Are you sure you want to move the selected interviews to 'Closed'?",
            async () => {
                await fetch('/api/interviews/bulk-update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interviewIds: Array.from(selectedInterviewIds), status: 'closed' })
                });
                selectedInterviewIds.clear();
                updateBulkActionBar();
                loadCounts();
                fetchAndRenderInterviews();
            }
        );
    });

    moveToOpenBtn.addEventListener('click', () => {
        showConfirmModal(
            `Re-open ${selectedInterviewIds.size} interviews?`,
            "Are you sure you want to move the selected interviews back to 'Open'?",
            async () => {
                await fetch('/api/interviews/bulk-update-status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interviewIds: Array.from(selectedInterviewIds), status: 'open' })
                });
                selectedInterviewIds.clear();
                updateBulkActionBar();
                loadCounts();
                fetchAndRenderInterviews();
            }
        );
    });

    deleteSelectedBtn.addEventListener('click', () => {
        showConfirmModal(
            `Delete ${selectedInterviewIds.size} interviews?`,
            "This action is permanent. All associated candidate data will also be deleted.",
            async () => {
                await fetch('/api/interviews/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ interviewIds: Array.from(selectedInterviewIds) })
                });
                selectedInterviewIds.clear();
                updateBulkActionBar();
                loadCounts();
                fetchAndRenderInterviews();
            }
        );
    });

    // Updated search bar to use client-side filtering
    searchBar.addEventListener('input', (e) => {
      renderTable(e.target.value);
    });

    // Initial Load & Polling
    loadCounts();
    fetchAndRenderInterviews();
    setInterval(() => {
        console.log("Refreshing HR dashboard data...");
        loadCounts();
        fetchAndRenderInterviews();
    }, 5000);
  });
</script>

</body>
</html>