<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <title>HireXpert - Admin Panel</title>
    <link crossorigin href="https://fonts.gstatic.com" rel="preconnect"/>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&family=Inter:wght@400;500;600;700&family=Noto+Sans:wght@400;500;700;900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style type="text/tailwindcss">
      :root {
        --primary-color: #1173d4;
        --secondary-color: #f0f2f4;
        --text-primary: #111418;
        --text-secondary: #617589;
      }
      .status-badge { @apply inline-flex items-center justify-center gap-2 rounded-full px-3 py-1 text-xs font-medium; }
      .status-active { @apply bg-green-100 text-green-800; }
      .status-inactive { @apply bg-red-100 text-red-800; }
      .status-dot { @apply h-2 w-2 rounded-full; }
      .tab-btn { @apply rounded-md px-4 py-2 text-sm font-medium text-gray-600 transition; }
      .tab-btn-active { @apply bg-white text-gray-900 shadow-sm; }
      
      /* Toggle Switch Styles */
      .toggle-label { @apply relative inline-flex cursor-pointer items-center; }
      /* ========== CORRECTED: Removed problematic rule ========== */
      /* .toggle-input { @apply sr-only peer; } <-- This line was causing the CSS to break */
      .toggle-bg { @apply h-6 w-11 rounded-full bg-gray-200 after:absolute after:start-[2px] after:top-[2px] after:h-5 after:w-5 after:rounded-full after:border after:border-gray-300 after:bg-white after:transition-all peer-checked:bg-green-600 peer-checked:after:translate-x-full peer-checked:after:border-white; }
    </style>
</head>
<body class="bg-gray-50 font-sans" style='font-family: Inter, "Noto Sans", sans-serif;'>
<div class="relative flex size-full min-h-screen flex-col bg-white group/design-root overflow-x-hidden">
<div class="flex h-full w-full">
<aside class="flex h-screen w-64 flex-col border-r border-gray-200 bg-white">
    <div class="flex h-16 items-center justify-center border-b border-gray-200">
        <h1 class="text-xl font-bold text-[var(--text-primary)]">Admin Panel</h1>
    </div>
    <nav class="flex-1 space-y-2 p-4">
        <a class="flex items-center gap-3 rounded-md bg-[var(--secondary-color)] px-3 py-2 text-sm font-medium text-[var(--text-primary)]" href="#">
            <span class="material-symbols-outlined text-[var(--text-primary)]">dashboard</span>
            Dashboard
        </a>
        <a class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium text-[var(--text-secondary)] hover:bg-gray-100" href="settings.html">
            <span class="material-symbols-outlined">settings</span>
            Settings
        </a>
        <a class="flex items-center gap-3 rounded-md px-3 py-2 text-sm font-medium text-[var(--text-secondary)] hover:bg-gray-100" href="#">
            <span class="material-symbols-outlined">logout</span>
            Logout
        </a>
    </nav>
</aside>
<main class="flex-1 bg-gray-50 p-8">
    <h1 class="text-3xl font-bold text-[var(--text-primary)]">System Control Panel</h1>
    
    <div class="mt-8">
        <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-4">Analytics Overview</h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                <div class="flex justify-between items-center mb-4"><h3 class="font-semibold text-gray-800">Interviews Scheduled</h3><div class="flex items-center gap-1 rounded-lg bg-gray-100 p-1"><button id="7d-btn" class="px-3 py-1 text-sm font-medium text-gray-700 rounded-md bg-white shadow">7D</button><button id="14d-btn" class="px-3 py-1 text-sm font-medium text-gray-500 rounded-md hover:bg-white hover:shadow">14D</button><button id="30d-btn" class="px-3 py-1 text-sm font-medium text-gray-500 rounded-md hover:bg-white hover:shadow">30D</button></div></div>
                <div class="relative h-64"><canvas id="interviewsLineChart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                 <h3 class="font-semibold text-gray-800 mb-4 text-center">Candidate Status Distribution</h3>
                <div class="relative mx-auto h-64" style="max-width: 256px;"><canvas id="statusPieChart"></canvas></div>
            </div>
        </div>
    </div>

    <div class="mt-12">
        <div class="mb-6"><div class="flex flex-col sm:flex-row sm:items-center sm:justify-between"><h2 class="text-2xl font-bold text-[var(--text-primary)]">All Scheduled Interviews</h2><div class="flex items-center gap-2 rounded-lg bg-gray-100 p-1 mt-4 sm:mt-0"><button id="open-interviews-btn" class="tab-btn tab-btn-active">Open</button><button id="closed-interviews-btn" class="tab-btn">Closed</button></div></div><div class="mt-4 border-b border-gray-200"><nav class="-mb-px flex space-x-6" aria-label="Tabs"><button id="dept-all-btn" class="whitespace-nowrap border-b-2 border-[var(--primary-color)] px-1 py-3 text-sm font-medium text-[var(--primary-color)]">All Departments</button><button id="dept-hr-btn" class="whitespace-nowrap border-b-2 border-transparent px-1 py-3 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">HR</button><button id="dept-pmo-btn" class="whitespace-nowrap border-b-2 border-transparent px-1 py-3 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">PMO</button><button id="dept-gta-btn" class="whitespace-nowrap border-b-2 border-transparent px-1 py-3 text-sm font-medium text-gray-500 hover:border-gray-300 hover:text-gray-700">GTA</button></nav></div></div>
        <div class="overflow-x-auto rounded-lg border border-gray-200 bg-white shadow-sm">
            <table class="min-w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Interview Title</th><th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Department</th><th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Open/Closed</th><th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Actions</th></tr></thead><tbody id="interviews-table-body" class="divide-y divide-gray-200"></tbody></table>
        </div>
        <div id="show-more-container" class="mt-4 text-center"></div>
    </div>

    <div class="mt-12">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold text-[var(--text-primary)]">System Users</h2>
            <div id="user-actions-normal" class="flex items-center gap-4">
                <button id="remove-user-mode-btn" class="flex items-center gap-2 rounded-md bg-red-100 px-4 py-2 text-sm font-medium text-red-700 hover:bg-red-200">
                    <span class="material-symbols-outlined">delete</span>
                    Remove User(s)
                </button>
                <button id="add-user-btn" class="flex items-center gap-2 rounded-md bg-[var(--primary-color)] px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-opacity-90">
                    <span class="material-symbols-outlined">add</span>
                    New User
                </button>
            </div>
            <div id="user-actions-delete" class="hidden flex items-center gap-4">
                <button id="cancel-delete-mode-btn" class="rounded-md bg-gray-200 px-4 py-2 text-sm font-medium text-gray-800 hover:bg-gray-300">Cancel</button>
                <button id="delete-selected-users-btn" class="flex items-center gap-2 rounded-md bg-red-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-red-700">
                    <span class="material-symbols-outlined">delete_forever</span>
                    Delete Selected
                </button>
            </div>
        </div>
        <div class="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr id="users-table-header">
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Department</th>
                        <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Status</th>
                    </tr>
                </thead>
                <tbody id="users-table-body" class="divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>
    
    <div class="mt-12">
        <h2 class="mb-6 text-2xl font-bold text-[var(--text-primary)]">All Candidates</h2>
        <div class="overflow-hidden rounded-lg border border-gray-200 bg-white shadow-sm"><table class="w-full"><thead class="bg-gray-50"><tr><th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Candidate Email</th><th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Interview Title</th><th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Department</th><th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Status</th></tr></thead><tbody id="candidates-table-body" class="divide-y divide-gray-200"></tbody></table></div>
    </div>
</main>
</div>
</div>

<div id="add-user-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
    <div class="w-full max-w-lg transform rounded-lg bg-white shadow-xl">
        <form id="add-user-form">
            <div class="p-6">
                <div class="flex items-center justify-between"><h3 class="text-xl font-semibold text-gray-900">Add New System User</h3><button type="button" id="close-add-user-modal" class="p-1 text-gray-400 rounded-full hover:bg-gray-200 hover:text-gray-600"><span class="material-symbols-outlined">close</span></button></div>
                <div class="mt-6 space-y-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div><label for="firstName" class="block text-sm font-medium text-gray-700">First Name</label><input type="text" id="firstName" name="firstName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]"></div>
                        <div><label for="lastName" class="block text-sm font-medium text-gray-700">Last Name</label><input type="text" id="lastName" name="lastName" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]"></div>
                    </div>
                    <div><label for="email" class="block text-sm font-medium text-gray-700">Email Address</label><input type="email" id="email" name="email" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]"></div>
                    <div><label for="department" class="block text-sm font-medium text-gray-700">Department</label><select id="department" name="department" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-[var(--primary-color)] focus:ring-[var(--primary-color)]"><option value="HR">HR</option><option value="PMO">PMO</option><option value="GTA">GTA</option></select></div>
                </div>
            </div>
            <div class="flex justify-end gap-3 border-t bg-gray-50 px-6 py-4"><button type="button" id="cancel-add-user" class="rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50">Cancel</button><button type="submit" class="rounded-md border border-transparent bg-[var(--primary-color)] px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-opacity-90">Create User</button></div>
        </form>
    </div>
</div>

<div id="notification-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-75">
    <div class="w-full max-w-sm transform rounded-lg bg-white p-6 shadow-xl text-center"><div id="notification-modal-icon" class="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100"><span class="material-symbols-outlined text-3xl text-green-600">check_circle</span></div><h3 id="notification-modal-title" class="mt-4 text-lg font-medium text-gray-900">Success!</h3><div class="mt-2"><p id="notification-modal-text" class="text-sm text-gray-500">Your action was completed.</p></div><div id="notification-modal-buttons" class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3"></div></div>
</div>

<script>
    // --- State Management ---
    let interviewsLineChartInstance = null;
    let pieChartInstance = null;
    let currentDays = 7;
    let currentInterviewStatus = 'open';
    let currentInterviewDepartment = null;
    let currentInterviewPage = 1;
    const INTERVIEWS_PER_PAGE = 5;
    let isUserDeleteMode = false;
    let allUsers = [];

    // --- Utility and Notification Functions ---
    function showNotification(title, text, options = {}) {
        const { isError = false, onConfirm = null, confirmText = 'Confirm', cancelText = 'Cancel' } = options;
        const modal = document.getElementById('notification-modal');
        const modalTitle = document.getElementById('notification-modal-title');
        const modalText = document.getElementById('notification-modal-text');
        const modalIcon = document.getElementById('notification-modal-icon');
        const btnContainer = document.getElementById('notification-modal-buttons');
        modalTitle.textContent = title;
        modalText.textContent = text;
        if (isError) { modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-red-600">error</span>`; modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100"; } else { modalIcon.innerHTML = `<span class="material-symbols-outlined text-3xl text-green-600">check_circle</span>`; modalIcon.className = "mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-green-100"; }
        btnContainer.innerHTML = '';
        if (onConfirm) { btnContainer.className = 'mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3'; const confirmBtn = document.createElement('button'); confirmBtn.type = 'button'; confirmBtn.className = isError ? 'inline-flex w-full justify-center rounded-md bg-red-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-red-500 sm:col-start-2' : 'inline-flex w-full justify-center rounded-md bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 sm:col-start-2'; confirmBtn.textContent = confirmText; confirmBtn.onclick = () => { modal.classList.add('hidden'); onConfirm(); }; const cancelBtn = document.createElement('button'); cancelBtn.type = 'button'; cancelBtn.className = 'mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:col-start-1 sm:mt-0'; cancelBtn.textContent = cancelText; cancelBtn.onclick = () => { modal.classList.add('hidden'); }; btnContainer.appendChild(cancelBtn); btnContainer.appendChild(confirmBtn);
        } else { btnContainer.className = 'mt-5 sm:mt-6'; const okBtn = document.createElement('button'); okBtn.type = 'button'; okBtn.className = 'inline-flex w-full h-10 justify-center items-center rounded-md bg-[var(--primary-color)] px-3 text-sm font-semibold text-white shadow-sm hover:bg-opacity-90'; okBtn.textContent = 'Got it'; okBtn.onclick = () => { modal.classList.add('hidden'); }; btnContainer.appendChild(okBtn); }
        modal.classList.remove('hidden');
    }

    // ========== RESTORED: Function for the Add User Modal ==========
    function setupAddUserModal() {
        const addUserModal = document.getElementById('add-user-modal');
        const addUserBtn = document.getElementById('add-user-btn');
        const closeBtn = document.getElementById('close-add-user-modal');
        const cancelBtn = document.getElementById('cancel-add-user');
        const addUserForm = document.getElementById('add-user-form');

        const openModal = () => addUserModal.classList.remove('hidden');
        const closeModal = () => {
            addUserModal.classList.add('hidden');
            addUserForm.reset();
        };

        addUserBtn.addEventListener('click', openModal);
        closeBtn.addEventListener('click', closeModal);
        cancelBtn.addEventListener('click', closeModal);

        addUserForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(addUserForm);
            const tempPassword = `${formData.get('firstName').toLowerCase().replace(/\s/g, '')}123`;
            const data = {
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                department: formData.get('department'),
                password: tempPassword 
            };
            
            try {
                const response = await fetch('/api/add-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message || 'Failed to create user.');
                showNotification('Success!', `User ${data.email} created. Temporary password is "${tempPassword}".`);
                closeModal();
                loadUsers(true);
            } catch (error) {
                showNotification('Error', error.message, { isError: true });
            }
        });
    }

    // --- Functions for User Deletion ---
    function setupUserDeleteMode() { /* ... (This and other functions are the same as the last full version) ... */ }
    async function deleteSelectedUsers(userIds) { /* ... */ }
    async function toggleInterviewStatus(id) { /* ... */ }
    async function loadUsers(isBackgroundRefresh = false) { /* ... */ }
    function renderUsersTable() { /* ... */ }
    async function loadInterviews(isLoadMore = false) { /* ... */ }
    function confirmDeleteInterview(id, title) { /* ... */ }
    async function deleteInterview(id) { /* ... */ }
    async function loadCandidates(isBackgroundRefresh = false) { /* ... */ }
    async function loadLineChartData(days, withAnimation = true) { /* ... */ }
    async function loadPieChartData(withAnimation = true) { /* ... */ }

    // --- MAIN SCRIPT ON PAGE LOAD ---
    document.addEventListener('DOMContentLoaded', () => {
        setupAddUserModal(); // RESTORED
        setupUserDeleteMode(); 

        loadPieChartData();
        loadUsers();
        loadCandidates();
        loadLineChartData(currentDays);
        loadInterviews();
        
        setInterval(() => {
            console.log("Refreshing admin dashboard data...");
            loadPieChartData(false);
            if (!isUserDeleteMode) loadUsers(true);
            loadCandidates(true);
        }, 5000);

        // (All event listeners are the same as the last full version)
        const statusBtns = { open: document.getElementById('open-interviews-btn'), closed: document.getElementById('closed-interviews-btn') };
        const deptBtns = { all: document.getElementById('dept-all-btn'), hr: document.getElementById('dept-hr-btn'), pmo: document.getElementById('dept-pmo-btn'), gta: document.getElementById('dept-gta-btn') };
        const handleFilterChange = () => { currentInterviewPage = 1; loadInterviews(); };
        Object.entries(statusBtns).forEach(([key, btn]) => { btn.addEventListener('click', () => { currentInterviewStatus = key; Object.values(statusBtns).forEach(b => b.classList.remove('tab-btn-active')); btn.classList.add('tab-btn-active'); handleFilterChange(); }); });
        const departmentMap = { all: null, hr: 'HR', pmo: 'PMO', gta: 'GTA' };
        Object.entries(deptBtns).forEach(([key, btn]) => { btn.addEventListener('click', () => { currentInterviewDepartment = departmentMap[key]; Object.values(deptBtns).forEach(b => { b.classList.remove('border-[var(--primary-color)]', 'text-[var(--primary-color)]'); b.classList.add('border-transparent', 'text-gray-500'); }); btn.classList.add('border-[var(--primary-color)]', 'text-[var(--primary-color)]'); btn.classList.remove('border-transparent', 'text-gray-500'); handleFilterChange(); }); });
        const lineChartButtons = { '7d': document.getElementById('7d-btn'), '14d': document.getElementById('14d-btn'), '30d': document.getElementById('30d-btn') };
        const handleLineChartClick = (days, clickedBtnKey) => { currentDays = days; Object.keys(lineChartButtons).forEach(key => { lineChartButtons[key].classList.remove('bg-white', 'shadow', 'text-gray-700'); lineChartButtons[key].classList.add('text-gray-500','hover:bg-white', 'hover:shadow'); }); lineChartButtons[clickedBtnKey].classList.add('bg-white', 'shadow', 'text-gray-700'); lineChartButtons[clickedBtnKey].classList.remove('text-gray-500','hover:bg-white', 'hover:shadow'); loadLineChartData(days); };
        lineChartButtons['7d'].addEventListener('click', () => handleLineChartClick(7, '7d'));
        lineChartButtons['14d'].addEventListener('click', () => handleLineChartClick(14, '14d'));
        lineChartButtons['30d'].addEventListener('click', () => handleLineChartClick(30, '30d'));
    });

    // --- Full, Unchanged Functions Pasted Below For Completeness ---
    function setupUserDeleteMode(){const n=document.getElementById("user-actions-normal"),e=document.getElementById("user-actions-delete"),t=document.getElementById("remove-user-mode-btn"),d=document.getElementById("cancel-delete-mode-btn"),o=document.getElementById("delete-selected-users-btn");t.addEventListener("click",()=>((e,t)=>{isUserDeleteMode=e,n.classList.toggle("hidden",e),t.classList.toggle("hidden",!e),renderUsersTable()})(!![],e)),d.addEventListener("click",()=>((e,t)=>{isUserDeleteMode=e,n.classList.toggle("hidden",e),t.classList.toggle("hidden",!e),renderUsersTable()})(![],e)),o.addEventListener("click",()=>{const n=Array.from(document.querySelectorAll(".user-checkbox:checked")).map(n=>n.value);0!==n.length?showNotification("Delete Users?",`Are you sure you want to delete ${n.length} user(s)? This action cannot be undone.`,{isError:!0,onConfirm:()=>deleteSelectedUsers(n),confirmText:"Yes, Delete",cancelText:"Cancel"}):showNotification("No Users Selected","Please select at least one user to delete.",{isError:!0})})}
    async function deleteSelectedUsers(n){try{const e=await fetch("/api/users/bulk-delete",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userIds:n})}),t=await e.json();if(!e.ok)throw new Error(t.message||"Failed to delete users.");showNotification("Success",t.message||"Selected users have been deleted."),isUserDeleteMode=!1,document.getElementById("user-actions-normal").classList.remove("hidden"),document.getElementById("user-actions-delete").classList.add("hidden"),loadUsers()}catch(n){showNotification("Error",n.message,{isError:!0})}}
    async function toggleInterviewStatus(n){try{const e=await fetch(`/api/interview/${n}/toggle-status`,{method:"POST"}),t=await e.json();if(!e.ok)throw new Error(t.message||"Failed to update status.");loadInterviews()}catch(n){showNotification("Error",n.message,{isError:!0})}}
    function renderUsersTable(){const n=document.getElementById("users-table-body"),e=document.getElementById("users-table-header");if(n.innerHTML="",isUserDeleteMode?e.innerHTML=`\n                <th class="w-12 px-6 py-3"><input type="checkbox" id="select-all-users" class="rounded border-gray-300"></th>\n                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Name</th>\n                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Email</th>\n                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Department</th>\n            `:e.innerHTML=`\n                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Name</th>\n                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Email</th>\n                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Department</th>\n                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-[var(--text-secondary)]">Status</th>\n            `,0===allUsers.length)return void(n.innerHTML=`<tr><td colspan="4" class="text-center p-4">No users found.</td></tr>`);allUsers.forEach(e=>{const t=document.createElement("tr");isUserDeleteMode?t.innerHTML=`\n                    <td class="px-6 py-4"><input type="checkbox" class="user-checkbox rounded border-gray-300" value="${e.id}"></td>\n                    <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-[var(--text-primary)]">${e.first_name} ${e.last_name}</td>\n                    <td class="whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">${e.email}</td>\n                    <td class="whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">${e.department}</td>\n                `:t.innerHTML=`\n                    <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-[var(--text-primary)]">${e.first_name} ${e.last_name}</td>\n                    <td class="whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">${e.email}</td>\n                    <td class="whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">${e.department}</td>\n                    <td class="whitespace-nowrap px-6 py-4"><div class="status-badge status-active"><span class="status-dot bg-green-500"></span>Active</div></td>\n                `,n.appendChild(t)}),isUserDeleteMode&&document.getElementById("select-all-users").addEventListener("change",n=>{document.querySelectorAll(".user-checkbox").forEach(e=>e.checked=n.target.checked)})}
    async function loadInterviews(n=!1){const e=document.getElementById("interviews-table-body"),t=document.getElementById("show-more-container");let d=n?INTERVIEWS_PER_PAGE:10;n||(e.innerHTML='<tr><td colspan="4" class="text-center p-4 text-gray-500">Loading...</td></tr>');let o=`/api/interviews?position_status=${currentInterviewStatus}&page=${currentInterviewPage}&limit=${d}`;currentInterviewDepartment&&(o+=`&department=${currentInterviewDepartment}`);try{const s=await fetch(o);if(!s.ok)throw new Error("Failed to fetch interviews");const a=await s.json();if(n||(e.innerHTML=""),0===a.length&&!n&&(e.innerHTML=`<tr><td colspan="4" class="text-center p-4 text-gray-500">No ${currentInterviewStatus} interviews found.</td></tr>`),a.forEach(n=>{const d=document.createElement("tr"),o="open"===n.position_status?"checked":"";d.innerHTML=`\n                    <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-[var(--text-primary)]">${n.title}</td>\n                    <td class="whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">${n.department}</td>\n                    <td class="px-6 py-4">\n                        <label class="toggle-label">\n                            <input type="checkbox" class="sr-only peer" onchange="toggleInterviewStatus('${n.id}')" ${o}>\n                            <div class="toggle-bg"></div>\n                        </label>\n                    </td>\n                    <td class="whitespace-nowrap px-6 py-4 text-sm">\n                        <button onclick="confirmDeleteInterview('${n.id}', '${n.title.replace(/'/g,"\\'")}')" class="text-red-600 hover:text-red-800 transition">Delete</button>\n                    </td>\n                `,e.appendChild(d)}),t.innerHTML="",a.length===d){const e=document.createElement("button");e.id="show-more-btn",e.className="rounded-md bg-gray-100 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-200",e.textContent="Show More",t.appendChild(e),e.addEventListener("click",()=>{currentInterviewPage++,loadInterviews(!0)})}}catch(n){console.error("Failed to load interviews:",n),e.innerHTML=`<tr><td colspan="4" class="text-center p-4 text-red-500">Failed to load interviews.</td></tr>`}}
    function confirmDeleteInterview(n,e){showNotification("Delete Interview?",`Are you sure you want to delete the interview "${e}"? This will also delete all associated candidate sessions and cannot be undone.`,{isError:!0,onConfirm:()=>deleteInterview(n),confirmText:"Yes, Delete",cancelText:"Cancel"})}
    async function deleteInterview(n){try{const e=await fetch(`/api/interview/${n}/delete`,{method:"DELETE"}),t=await e.json();if(!e.ok)throw new Error(t.message||"Failed to delete interview.");showNotification("Success","The interview has been deleted successfully."),currentInterviewPage=1,loadInterviews()}catch(n){showNotification("Error",n.message,{isError:!0})}}
    async function loadCandidates(n=!1){const e=document.getElementById("candidates-table-body");0===e.childElementCount&&!n&&(e.innerHTML='<tr><td colspan="4" class="text-center p-4 text-gray-500">Loading...</td></tr>');try{const t=await fetch("/api/candidates/all");if(!t.ok)throw new Error("Failed to fetch candidate data");const d=await t.json();if(e.innerHTML="",0===d.length)return void(e.innerHTML='<tr><td colspan="4" class="text-center p-4 text-gray-500">No candidates found in the system.</td></tr>');d.forEach(n=>{const t=document.createElement("tr");t.innerHTML=`\n                    <td class="whitespace-nowrap px-6 py-4 text-sm font-medium text-[var(--text-primary)]">${n.candidate_email}</td>\n                    <td class="whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">${n.interview_title}</td>\n                    <td class="whitespace-nowrap px-6 py-4 text-sm text-[var(--text-secondary)]">${n.department}</td>\n                    <td class="whitespace-nowrap px-6 py-4">\n                         <div class="status-badge ${"Completed"===n.status?"status-active":"bg-yellow-100 text-yellow-800"}">\n                            ${n.status}\n                         </div>\n                    </td>\n                `,e.appendChild(t)})}catch(n){console.error("Failed to load candidates:",n),e.innerHTML='<tr><td colspan="4" class="text-center p-4 text-red-500">Failed to load candidate data.</td></tr>'}}
    async function loadLineChartData(n,e=!0){try{const t=await fetch(`/api/analytics/interviews-over-time?days=${n}`);if(!t.ok)throw new Error("Failed to fetch line chart data");const d=await t.json(),o=[],s=[];const a=new Map(d.map(n=>[new Date(n.date).toISOString().split("T")[0],n.count]));for(let n=d-1;n>=0;n--){const e=new Date;e.setDate(e.getDate()-n);const t=e.toISOString().split("T")[0];o.push(e.toLocaleDateString(void 0,{month:"short",day:"numeric"})),s.push(parseInt(a.get(t)||0))}const i=document.getElementById("interviewsLineChart").getContext("2d");if(interviewsLineChartInstance&&!e)return interviewsLineChartInstance.data.labels=o,interviewsLineChartInstance.data.datasets[0].data=s,void interviewsLineChartInstance.update("none");interviewsLineChartInstance&&interviewsLineChartInstance.destroy(),interviewsLineChartInstance=new Chart(i,{type:"line",data:{labels:o,datasets:[{label:"Interviews Scheduled",data:s,backgroundColor:"rgba(17, 115, 212, 0.1)",borderColor:"rgba(17, 115, 212, 1)",borderWidth:2,tension:.3,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,scales:{y:{beginAtZero:!0,ticks:{stepSize:1}}},plugins:{legend:{display:!1}}}})}catch(n){console.error(`Failed to load line chart data for ${n} days:`,n)}}
    async function loadPieChartData(n=!0){try{const e=await fetch("/api/analytics/status-counts");if(!e.ok)throw new Error("Failed to fetch pie chart data");const t=await e.json(),d=document.getElementById("statusPieChart").getContext("2d"),o=t.map(n=>n.status),s=t.map(n=>n.count);if(pieChartInstance&&!n)return pieChartInstance.data.labels=o,pieChartInstance.data.datasets[0].data=s,void pieChartInstance.update("none");pieChartInstance&&pieChartInstance.destroy(),pieChartInstance=new Chart(d,{type:"pie",data:{labels:o,datasets:[{data:s,backgroundColor:["rgba(54, 162, 235, 0.7)","rgba(255, 206, 86, 0.7)","rgba(75, 192, 192, 0.7)","rgba(255, 99, 132, 0.7)"],borderColor:["#fff"],borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"top"}}}})}catch(n){console.error("Failed to load pie chart data:",n);const e=document.getElementById("statusPieChart");e&&(e.parentElement.innerHTML='<p class="text-center text-red-500">Could not load status data.</p>')}}
</script>
</body>
</html>